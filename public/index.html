<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ARCHIVE</title>
  
  <link rel="icon" type="image/svg+xml" href="/logos/logo.svg">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="/edittrax-styles.css">
  
  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getFirestore, collection, query, where, orderBy, onSnapshot, addDoc, doc, getDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
    import { getStorage, ref, uploadBytesResumable, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyB8zZex61GBZKqnAJVnIv3s5LIaangLUts",
      authDomain: "editvideos-63486.firebaseapp.com",
      projectId: "editvideos-63486",
      storageBucket: "editvideos-63486.firebasestorage.app",
      messagingSenderId: "136146097402",
      appId: "1:136146097402:web:1cc75f9dff37f4d48a2543"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // Make available globally
    window.firebase = { 
      db, 
      storage, 
      collection, 
      query, 
      where, 
      orderBy, 
      onSnapshot, 
      addDoc, 
      doc, 
      getDoc, 
      ref, 
      getDownloadURL,
      uploadBytesResumable
    };
  </script>

  <!-- Define toggleCollapsible early so it's available for onclick handlers -->
  <script>
    window.toggleCollapsible = function(sectionId) {
      const panel = document.getElementById(sectionId);
      if (!panel) {
        console.error(`[toggleCollapsible] Panel not found: ${sectionId}`);
        return;
      }
      const toggle = panel.previousElementSibling;
      const wasOpen = panel.classList.contains('open');
      
      // Close all other sections (accordion behavior)
      if (!wasOpen) {
        const allPanels = document.querySelectorAll('.collapsible-body');
        allPanels.forEach(otherPanel => {
          if (otherPanel.id !== sectionId && otherPanel.classList.contains('open')) {
            otherPanel.classList.remove('open');
            const otherToggle = otherPanel.previousElementSibling;
            if (otherToggle && otherToggle.tagName === 'BUTTON') {
              otherToggle.setAttribute('aria-expanded', 'false');
            }
          }
        });
      }
      
      // Toggle the open class
      if (wasOpen) {
        panel.classList.remove('open');
      } else {
        panel.classList.add('open');
      }
      
      const isNowOpen = panel.classList.contains('open');
      
      // Update aria-expanded attribute
      if (toggle && toggle.tagName === 'BUTTON') {
        toggle.setAttribute('aria-expanded', isNowOpen.toString());
      }
      
      // Load data when sections are opened
      if (isNowOpen && !wasOpen) {
        if (sectionId === 'archiveSection') {
          setTimeout(() => {
            if (typeof window.loadArchiveFolders === 'function') window.loadArchiveFolders();
            if (typeof window.loadArchiveManifest === 'function') window.loadArchiveManifest();
          }, 100);
        } else if (sectionId === 'uploadSection') {
          setTimeout(() => {
            if (typeof window.loadFolders === 'function') window.loadFolders();
          }, 100);
        }
      }
    };
  </script>

  <style>
    /* Keep essential styles from original */
    html {
      overflow-x: hidden;
      width: 100%;
      max-width: 100%;
    }
    
    body {
      overflow-x: hidden;
      width: 100%;
      max-width: 100%;
      margin: 0;
      padding: 0;
      background: linear-gradient(180deg, #000000 0%, #0a0a0a 100%);
    }
    
    #particles-js {
      position: fixed;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
      z-index: -1;
      background: linear-gradient(180deg, #000000 0%, #0a0a0a 100%);
    }
  </style>
</head>
<body class="min-h-screen">
  
  <!-- Color Bar - Top Border -->
  <img src="/logos/color_bar.png" alt="" style="position: fixed; top: 0; left: 0; width: 100%; height: 5px; max-height: 5px; z-index: 9999; pointer-events: none; display: block; object-fit: cover;">
  
  <!-- Particle Background -->
  <div id="particles-js"></div>
  
  <!-- Header -->
  <header class="header-edittrax">
    <div class="max-w-6xl mx-auto pt-3" style="position: relative;">
      
      <!-- System Status and Actions -->
      <div style="position: absolute; top: 1rem; left: 0; right: 0; z-index: 1000; display: flex; justify-content: space-between; align-items: flex-start; padding: 0 1rem;">
        <!-- System Health Status -->
        <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-start;">
          <div id="statusArweave" class="status-indicator" style="display: flex; align-items: center; gap: 0.4rem;">
            <span class="status-dot" style="width: 8px; height: 8px; border-radius: 50%; background: #888888;"></span>
            <span style="font-family: var(--font-mathias); color: var(--color-yellow-75); font-size: 0.7rem; white-space: nowrap;">ARWEAVE</span>
          </div>
          <div id="statusVideoGen" class="status-indicator" style="display: flex; align-items: center; gap: 0.4rem;">
            <span class="status-dot" style="width: 8px; height: 8px; border-radius: 50%; background: #888888;"></span>
            <span style="font-family: var(--font-mathias); color: var(--color-yellow-75); font-size: 0.7rem; white-space: nowrap;">VIDEO GEN</span>
          </div>
          <div id="statusWebsite" class="status-indicator" style="display: flex; align-items: center; gap: 0.4rem;">
            <span class="status-dot" style="width: 8px; height: 8px; border-radius: 50%; background: #888888;"></span>
            <span style="font-family: var(--font-mathias); color: var(--color-yellow-75); font-size: 0.7rem; white-space: nowrap;">WEBSITE</span>
          </div>
          <div id="statusStorage" class="status-indicator" style="display: flex; align-items: center; gap: 0.4rem;">
            <span class="status-dot" style="width: 8px; height: 8px; border-radius: 50%; background: #888888;"></span>
            <span style="font-family: var(--font-mathias); color: var(--color-yellow-75); font-size: 0.7rem; white-space: nowrap;">STORAGE</span>
          </div>
        </div>
        
        <!-- Right Side: Refresh Button and Usage Indicators -->
        <div style="display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end;">
          <button 
            onclick="window.location.reload()"
            class="btn-base btn-secondary"
            style="padding: 0.5rem 1rem; font-size: 0.75rem; white-space: nowrap;"
            onmouseover="this.style.opacity='0.9';"
            onmouseout="this.style.opacity='1';"
            onmousedown="this.style.opacity='0.8';"
            onmouseup="this.style.opacity='1';"
          >
            REFRESH
          </button>
          
          <!-- Storage Usage Indicator -->
          <div id="storageUsage" style="display: flex; flex-direction: column; gap: 0.2rem; align-items: flex-end;">
            <div style="display: flex; align-items: center; gap: 0.4rem; justify-content: flex-end;">
              <span id="storageUsageDot" class="status-dot" style="width: 8px; height: 8px; border-radius: 50%; background: #888888; flex-shrink: 0; transition: background-color 0.3s ease;"></span>
              <span id="storageUsageText" style="font-family: var(--font-mathias); color: var(--color-yellow-75); font-size: 0.7rem; white-space: nowrap;">Loading...</span>
            </div>
            <div id="storageCost" style="font-family: var(--font-mathias); color: var(--color-yellow-75); font-size: 0.65rem; white-space: nowrap; opacity: 0.8;">
              <span id="storageCostText">-</span>
            </div>
          </div>
          
          <!-- Firestore Usage Indicator -->
          <div id="firestoreUsage" style="display: flex; flex-direction: column; gap: 0.2rem; align-items: flex-end;">
            <div style="display: flex; align-items: center; gap: 0.4rem; justify-content: flex-end;">
              <span id="firestoreUsageDot" class="status-dot" style="width: 8px; height: 8px; border-radius: 50%; background: #888888; flex-shrink: 0; transition: background-color 0.3s ease;"></span>
              <span id="firestoreUsageText" style="font-family: var(--font-mathias); color: var(--color-yellow-75); font-size: 0.7rem; white-space: nowrap;">Loading...</span>
            </div>
            <div id="firestoreCost" style="font-family: var(--font-mathias); color: var(--color-yellow-75); font-size: 0.65rem; white-space: nowrap; opacity: 0.8;">
              <span id="firestoreCostText">-</span>
            </div>
          </div>
          
        </div>
      </div>
      
      <div class="flex flex-col items-center gap-4 w-full px-4 sm:px-0">
        <div class="logo-container flex flex-col items-center gap-2">
          <img id="logoGif" src="/logos/load.gif" alt="Loading Animation" style="width: 120px; height: auto;">
          <div id="headerLoadingState" style="display: none; width: 120px; height: 120px; display: flex; align-items: center; justify-content: center;">
            <div class="inline-block w-8 h-8 border-2 border-t-transparent rounded-full animate-spin" style="border-color: var(--color-yellow-75); border-top-color: transparent;"></div>
          </div>
          <h1 style="font-family: var(--font-mathias); color: var(--color-yellow-75); font-size: 1.8rem; text-transform: uppercase; letter-spacing: 0.08em; background: radial-gradient(ellipse at center, rgba(230, 233, 224, 1) 0%, rgba(230, 233, 224, 0.95) 40%, rgba(200, 203, 194, 0.9) 80%, rgba(180, 183, 174, 0.85) 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">ARCHIVE</h1>
        </div>

        <div class="control-stack">
          <div class="collapsible-card">
            <button class="collapsible-toggle" onclick="toggleCollapsible('uploadSection')" aria-expanded="false">
              <div>
                <div style="font-family: var(--font-mathias); font-weight: bold; line-height: 1.2; font-size: 1.8rem;">UPLOAD</div>
                <div style="font-family: var(--font-body); font-size: 0.45rem; margin-top: 0.15rem;">Content</div>
              </div>
              <span class="chevron">‚ñ∏</span>
            </button>
            <div id="uploadSection" class="collapsible-body">
              <div class="stepper-card">
                <div class="step-block">
                  <div class="step-label">Quick actions</div>
                  <div class="step-hint">Upload source files</div>
                  <div class="action-row" style="margin-top: 0.35rem;">
                    <button 
                      id="uploadVideoBtn" 
                      onclick="showUploadModal()"
                      class="btn-base btn-secondary full-btn rounded text-center whitespace-nowrap"
                      style="transition: all 0.3s ease; background: transparent; color: var(--color-yellow-75); border: 2px solid var(--color-yellow-75); font-weight: bold; border-radius: 10px;"
                    >
                      Upload Video
                    </button>
                    <button 
                      id="uploadMixBtn" 
                      onclick="showUploadMixModal()"
                      class="btn-base btn-secondary full-btn rounded text-center whitespace-nowrap"
                      style="transition: all 0.3s ease; background: transparent; color: var(--color-yellow-75); border: 2px solid var(--color-yellow-75); font-weight: bold; border-radius: 10px;"
                    >
                      Upload Mix
                    </button>
                    <button 
                      id="uploadArtistImageBtn" 
                      onclick="showArtistImageModal()"
                      class="btn-base btn-secondary full-btn rounded text-center whitespace-nowrap"
                      style="transition: all 0.3s ease; background: transparent; color: var(--color-yellow-75); border: 2px solid var(--color-yellow-75); font-weight: bold; border-radius: 10px;"
                    >
                      Upload Image
                    </button>
                  </div>
                </div>
                <div class="step-block">
                  <div class="step-label">View uploaded videos</div>
                  <div class="step-hint">Browse and delete</div>
                  <div id="uploadedVideosSection" style="margin-top: 0.75rem;">
                    <!-- Folder List View -->
                    <div id="folderListView" class="card-edittrax rounded-lg mb-4" style="overflow: hidden; border: 2px solid var(--color-yellow-75);">
                      <div style="background-color: var(--color-yellow-75); padding: 1rem;">
                        <h2 style="color: black; font-family: var(--font-mathias); font-size: 1.25rem; margin: 0; text-align: center;">
                          Video Folders
                        </h2>
                      </div>
                      <div style="padding: 1.5rem;">
                        <div id="foldersGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 1rem; width: 100%;">
                          <!-- Folders will be populated here -->
                        </div>
                        <div id="foldersLoading" style="text-align: center; padding: 2rem; color: var(--color-yellow-75);">
                          Loading folders...
                        </div>
                      </div>
                    </div>

                    <!-- Folder Detail View -->
                    <div id="folderDetailView" style="display: none;">
                      <div class="card-edittrax rounded-lg mb-4" style="overflow: hidden; border: 2px solid var(--color-yellow-75);">
                        <div style="background-color: var(--color-yellow-75); padding: 1rem; display: flex; justify-content: space-between; align-items: center;">
                          <h2 id="folderDetailTitle" style="color: black; font-family: var(--font-mathias); font-size: 1.25rem; margin: 0;">
                            Folder Name
                          </h2>
                          <button 
                            onclick="backToFolders()"
                            class="btn-base btn-secondary"
                            style="padding: 0.5rem 1rem; background: black; color: var(--color-yellow-75); border: none; border-radius: 10px; font-family: var(--font-mathias); font-weight: bold; cursor: pointer; font-size: 0.875rem; width: auto; min-width: 120px;"
                          >
                            ‚Üê Back
                          </button>
                        </div>
                        <div style="padding: 1.5rem;">
                          <div id="videosGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1.5rem; width: 100%;">
                            <!-- Videos will be populated here -->
                          </div>
                          <div id="videosLoading" style="text-align: center; padding: 2rem; color: var(--color-yellow-75);">
                            Loading videos...
                          </div>
                          <div id="videosEmpty" style="text-align: center; padding: 2rem; color: var(--color-yellow-75); display: none;">
                            No videos in this folder.
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="collapsible-card">
            <button class="collapsible-toggle" onclick="toggleCollapsible('generateSection')" aria-expanded="false">
              <div>
                <div style="font-family: var(--font-mathias); font-weight: bold; line-height: 1.2; font-size: 1.8rem;">GENERATE</div>
                <div style="font-family: var(--font-body); font-size: 0.45rem; margin-top: 0.15rem;">Videos</div>
              </div>
              <span class="chevron">‚ñ∏</span>
            </button>
            <div id="generateSection" class="collapsible-body">
              <div class="stepper-card">
                <div class="step-block">
                  <div class="step-label">1. Select audio source</div>
                  <!-- <div class="step-hint"></div> -->
                  <div class="full-width-group" style="margin-top: 0.5rem;">
                    <button 
                      id="audioSourceMixes" 
                      onclick="selectAudioSource('mixes')"
                      class="btn-base btn-primary full-btn"
                      style="border-radius: 8px;"
                    >
                      DJ MIXES
                    </button>
                    <button 
                      id="audioSourceTracks" 
                      onclick="selectAudioSource('tracks')"
                      class="btn-base btn-secondary full-btn"
                      style="border-radius: 8px; background: #0a0a0a; color: var(--color-yellow-75);"
                    >
                      ORIGINAL TRACKS
                    </button>
                  </div>
                </div>

                <div id="artistSelectionContainer" class="step-block" style="display: none;">
                  <div class="step-label">2. Select artist</div>
                  <div class="step-hint"></div>
                  <select 
                    id="artistSelect"
                    class="select-styled"
                    style="margin: 0.35rem auto 0;"
                  >
                    <option value="random">Random Artist</option>
                  </select>
                </div>

                <div id="folderSelectionContainer" class="step-block" style="display: none;">
                  <div class="step-label">3. Select folders</div>
                  <div class="step-hint"></div>
                  <div id="folderCheckboxes" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; width: 100%; margin: 0 auto;">
                    <!-- Folders will be populated dynamically -->
                  </div>
                </div>

                <div id="filterSelectionContainer" class="step-block" style="display: none;">
                  <div class="step-label">4. Add filter</div>
                  <div class="step-hint"></div>
                  <select 
                    id="filterSelect"
                    class="select-styled"
                    style="margin: 0.35rem auto 0;"
                    onchange="updateFilterSelection(this.value)"
                  >
                    <option value="look_hard_bw_street_doc">Hard B&W Street Doc (Default)</option>
                    <option value="look_bw_contrast">B&W Contrast</option>
                    <option value="look_soft_bw">Soft B&W</option>
                    <option value="look_vintage_warm">Vintage Warm</option>
                    <option value="look_cool_blue">Cool Blue</option>
                  </select>
                </div>

                <div id="overlayToggleContainer" class="step-block" style="display: none;">
                  <div class="step-label">5. Overlay effect</div>
                  <div class="step-hint"></div>
                  <div id="overlayCheckboxContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.75rem; width: 100%; margin: 0 auto;">
                    <label class="folder-select-item unselected" style="gap: 0.75rem; cursor: pointer;">
                      <input 
                        type="checkbox" 
                        id="enableOverlay"
                        style="width: 20px; height: 20px; cursor: pointer; accent-color: #10b981;"
                        onchange="updateOverlayToggle(this.checked); this.parentElement.classList.toggle('selected', this.checked); this.parentElement.classList.toggle('unselected', !this.checked);"
                      />
                      <span style="color: var(--color-yellow-75); font-family: var(--font-body); font-weight: 700; font-size: 0.95rem;">
                        Enable Overlay Effect
                      </span>
                    </label>
                  </div>
                </div>

                <div class="step-block">
                  <div class="step-label">6. Generate</div>
                  <div class="step-hint"></div>
                  <div class="action-row" style="margin-top: 0.25rem;">
                    <button 
                      id="generateVideoBtn" 
                      onclick="generateVideo()"
                      class="btn-base btn-green-gradient full-btn rounded text-center whitespace-nowrap"
                    >
                      <span id="generateBtnText">GENERATE VIDEO</span>
                      <span id="generateBtnLoading" style="display: none;">Generating...</span>
                    </button>
                  </div>
                </div>

                <div class="step-block">
                  <div class="step-label">6. View Generated Videos</div>
                  <div class="step-hint"></div>
                  <div style="margin-top: 0.75rem;">
                    <!-- Videos Table -->
                    <div class="card-edittrax rounded-lg mb-4" style="overflow: hidden; border: 2px solid var(--color-yellow-75);">
                      <div class="table-container">
                        <table class="table-edittrax" style="border: none; margin: 0; border-collapse: collapse; width: 100%;">
                          <thead style="background-color: var(--color-yellow-75); border: none;">
                            <tr style="border: none;">
                              <th class="px-2" style="padding-top: 0.9rem; padding-bottom: 0.9rem; color: black; text-align: center; border: none;">ARTIST</th>
                              <th class="px-2" style="padding-top: 0.9rem; padding-bottom: 0.9rem; color: black; text-align: center;">DURATION</th>
                              <th class="px-2" style="padding-top: 0.9rem; padding-bottom: 0.9rem; color: black; text-align: center;"></th>
                              <th class="px-2" style="padding-top: 0.9rem; padding-bottom: 0.9rem; color: black; text-align: center;">ACTIONS</th>
                            </tr>
                          </thead>
                          <tbody id="videosTable">
                            <!-- Video rows will be populated dynamically -->
                            <tr>
                              <td colspan="4" style="text-align: center; padding: 2rem; color: var(--color-yellow-75);">
                                Click "GENERATE VIDEO" to create your first video!
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                      <div class="videos-mobile-list" id="videosMobileList" style="padding: 1rem;"></div>
                      <div style="display: flex; gap: 0.75rem; padding: 0.5rem 1rem 1.25rem; flex-wrap: wrap; justify-content: center;">
                        <button 
                          id="loadMoreBtn" 
                          onclick="loadMoreVideos()" 
                          class="btn-base btn-secondary full-btn" 
                          style="display: none; background: transparent; color: var(--color-yellow-75); border: 2px solid var(--color-yellow-75); font-weight: bold; border-radius: 10px;"
                        >
                          Load More
                        </button>
                        <button 
                          id="resetDismissedBtn" 
                          onclick="resetDismissedVideos()" 
                          class="btn-base btn-secondary full-btn" 
                          style="display: none; background: rgba(239,68,68,0.15); color: #ef4444; border: 2px solid #ef4444; font-weight: bold; border-radius: 10px;"
                        >
                          Restore Hidden Rows
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="collapsible-card">
            <button class="collapsible-toggle" onclick="toggleCollapsible('toolsSection')" aria-expanded="false">
              <div>
                <div style="font-family: var(--font-mathias); font-weight: bold; line-height: 1.2; font-size: 1.8rem;">DEPLOY</div>
                <div style="font-family: var(--font-body); font-size: 0.45rem; margin-top: 0.15rem;">Website</div>
              </div>
              <span class="chevron">‚ñ∏</span>
            </button>
            <div id="toolsSection" class="collapsible-body">
              <div class="stepper-card">
                <div class="step-block">
                  <div class="step-label">Management</div>
                  <div class="step-hint">Deploy site with new content</div>
                  <div class="action-row" style="margin-top: 0.35rem;">
                    <button 
                      id="deployWebsiteBtn" 
                      onclick="deployWebsite()"
                      class="btn-base btn-green-gradient full-btn rounded text-center whitespace-nowrap"
                    >
                      Deploy Website
                    </button>
                    <button 
                      onclick="openWebsite(); return false;"
                      class="btn-base btn-secondary full-btn"
                      style="background: #0a0a0a; color: var(--color-yellow-75); border: 2px solid var(--color-yellow-75); border-radius: 10px;"
                    >
                      View Site
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="collapsible-card">
            <button class="collapsible-toggle" onclick="toggleCollapsible('archiveSection')" aria-expanded="false">
              <div>
                <div style="font-family: var(--font-mathias); font-weight: bold; line-height: 1.2; font-size: 1.8rem;">MANAGE</div>
                <div style="font-family: var(--font-body); font-size: 0.45rem; margin-top: 0.15rem;">Archive</div>
              </div>
              <span class="chevron">‚ñ∏</span>
            </button>
            <div id="archiveSection" class="collapsible-body">
              <!-- Folder Selection Section -->
              <div style="background: rgba(0, 0, 0, 0.6); border: 2px solid var(--color-yellow-75); border-radius: 10px; padding: .5rem; margin-bottom: .5rem;">
                <h2 style="color: var(--color-yellow-75); font-family: var(--font-mathias); font-size: 1.125rem; margin-bottom: 1rem; text-align: center;">
                  Select Folder
                </h2>
                <div id="archiveFoldersContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; width: 100%;">
                  <!-- Folders will be populated here -->
                </div>
                <div id="archiveFoldersLoading" style="text-align: center; padding: 2rem; color: var(--color-yellow-75);">
                  Loading folders...
                </div>
              </div>

              <!-- File Selection Section -->
              <div id="archiveFileSelectionSection" style="display: none; background: rgba(0, 0, 0, 0.6); border: 2px solid var(--color-yellow-75); border-radius: 10px; padding: .5rem; margin-bottom: .5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                  <h2 style="color: var(--color-yellow-75); font-family: var(--font-mathias); font-size: 1.125rem; margin: 0;">
                    Files in <span id="archiveSelectedFolderName"></span>
                  </h2>
                  <div style="display: flex; gap: 0.5rem;">
                    <button onclick="archiveSelectAllFiles()" class="btn-base btn-secondary" style="padding: 0.5rem 1rem; border-radius: 10px; background: transparent; color: var(--color-yellow-75); border: 2px solid var(--color-yellow-75); font-family: var(--font-mathias); font-size: 0.75rem; cursor: pointer;">
                      Select All
                    </button>
                    <button onclick="archiveDeselectAllFiles()" class="btn-base btn-secondary" style="padding: 0.5rem 1rem; border-radius: 10px; background: transparent; color: var(--color-yellow-75); border: 2px solid var(--color-yellow-75); font-family: var(--font-mathias); font-size: 0.75rem; cursor: pointer;">
                      Deselect All
                    </button>
                  </div>
                </div>
                <div id="archiveFilesContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; width: 100%; max-height: 500px; overflow-y: auto;">
                  <!-- Files will be populated here -->
                </div>
                <div id="archiveFilesLoading" style="text-align: center; padding: 2rem; color: var(--color-yellow-75); display: none;">
                  Loading files...
                </div>
                <div id="archiveFilesEmpty" style="text-align: center; padding: 2rem; color: var(--color-yellow-75); display: none;">
                  No files in this folder.
                </div>
              </div>

              <!-- Upload Section -->
              <div id="archiveUploadSection" style="display: none; background: rgba(0, 0, 0, 0.6); border: 2px solid var(--color-yellow-75); border-radius: 10px; padding: 1.5rem; margin-bottom: 2rem;">
                <h2 style="color: var(--color-yellow-75); font-family: var(--font-mathias); font-size: 1.125rem; margin-bottom: 1rem; text-align: center;">
                  Archive Selected Files
                </h2>
                <div style="text-align: center; margin-bottom: 1.5rem;">
                  <button 
                    id="archiveBtn" 
                    onclick="archiveSelectedFiles()"
                    class="btn-base btn-primary full-btn"
                    style="border-radius: 10px; background: var(--color-yellow-75); color: black; border: 2px solid var(--color-yellow-75); font-family: var(--font-mathias); font-weight: bold; cursor: pointer; font-size: 1rem;"
                  >
                    Archive <span id="archiveSelectedCount">0</span> File(s) to Arweave
                  </button>
                </div>
                
                <!-- Progress Section -->
                <div id="archiveProgressSection" style="display: none;">
                  <h3 style="color: var(--color-yellow-75); font-family: var(--font-mathias); font-size: 1rem; margin-bottom: 1rem;">
                    Upload Progress
                  </h3>
                  <div style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                      <span style="color: var(--color-yellow-75); font-size: 0.875rem;">Overall Progress</span>
                      <span id="archiveOverallProgress" style="color: var(--color-yellow-75); font-size: 0.875rem;">0%</span>
                    </div>
                    <div style="width: 100%; height: 20px; background: #0a0a0a; border: 1px solid var(--color-yellow-75); border-radius: 10px; overflow: hidden;">
                      <div id="archiveOverallProgressBar" style="height: 100%; background: var(--color-yellow-75); width: 0%; transition: width 0.3s ease;"></div>
                    </div>
                  </div>
                  <div id="archiveFileProgressList" style="max-height: 400px; overflow-y: auto;">
                    <!-- Individual file progress will be shown here -->
                  </div>
                </div>
              </div>

              <!-- Archive Manifest View -->
              <div style="background: rgba(0, 0, 0, 0.6); border: 2px solid var(--color-yellow-75); border-radius: 10px; padding: 1.5rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                  <h2 style="color: var(--color-yellow-75); font-family: var(--font-mathias); font-size: 1.125rem; margin: 0;">
                    Archive Manifest
                  </h2>
                  <button onclick="loadArchiveManifest()" class="btn-base btn-secondary" style="padding: 0.5rem 1rem; border-radius: 10px; background: transparent; color: var(--color-yellow-75); border: 2px solid var(--color-yellow-75); font-family: var(--font-mathias); font-size: 0.75rem; cursor: pointer;">
                    Refresh
                  </button>
                </div>
                <div id="archiveManifestContainer">
                  <div style="text-align: center; padding: 2rem; color: var(--color-yellow-75);">
                    Loading manifest...
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="max-w-6xl mx-auto pb-4" style="width: 100%; box-sizing: border-box; overflow: visible; position: relative; padding-top: 2rem;">

    <!-- Error State -->
    <div id="errorState" class="hidden card rounded p-4 mb-4" style="border: 2px solid var(--color-red-75);">
      <h3 class="font-bold mb-2" style="color: var(--color-red-75);">Error</h3>
      <p id="errorMessage" class="text-sm" style="color: var(--color-yellow-75);"></p>
      <button onclick="loadVideos()" class="mt-3 btn-primary px-4 py-2 text-sm rounded" style="background: var(--color-yellow-75); color: black; border: none; cursor: pointer;">
        Retry
      </button>
    </div>

    <!-- Upload Mix Modal -->
    <div id="uploadMixModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center;">
      <div style="background: radial-gradient(ellipse at center, rgba(20, 20, 30, 0.7) 0%, rgba(0, 0, 0, 0.6) 100%); border: 2px solid var(--color-yellow-75); border-radius: 10px; padding: 2rem; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
          <h2 style="color: var(--color-yellow-75); font-family: var(--font-mathias); font-size: 1.5rem; margin: 0;">UPLOAD MIX/TRACK</h2>
          <button onclick="hideUploadMixModal()" style="background: transparent; border: none; color: var(--color-yellow-75); font-size: 1.5rem; cursor: pointer; padding: 0; width: 30px; height: 30px;">&times;</button>
        </div>
        
        <form id="uploadMixForm" onsubmit="handleMixUpload(event)" style="display: flex; flex-direction: column; gap: 1rem;">
          <div>
            <label style="display: block; color: var(--color-yellow-75); font-family: var(--font-mathias); margin-bottom: 0.5rem; font-size: 0.875rem;">
              Artist <span style="color: #ef4444;">*</span>
            </label>
            <select 
              id="mixArtistSelect" 
              required
              onchange="handleArtistSelection()"
              style="width: 100%; padding: 0.75rem; border: 2px solid var(--color-yellow-75); border-radius: 5px; background: #0a0a0a; color: var(--color-yellow-75); font-family: var(--font-mathias); margin-bottom: 0.5rem;"
            >
              <option value="">Select an artist...</option>
              <option value="__new__">+ Create New Artist</option>
            </select>
            <input 
              type="text" 
              id="mixArtistName" 
              placeholder="Enter new artist name"
              style="width: 100%; padding: 0.75rem; border: 2px solid var(--color-yellow-75); border-radius: 5px; background: #0a0a0a; color: var(--color-yellow-75); font-family: var(--font-mathias); display: none;"
            />
          </div>
          
          <div id="mixArtistImageContainer" style="display: none;">
            <label style="display: block; color: var(--color-yellow-75); font-family: var(--font-mathias); margin-bottom: 0.5rem; font-size: 0.875rem;">
              Artist Image <span style="color: #ef4444;">*</span> <span style="color: #888; font-size: 0.75rem;">(Required for new artists)</span>
            </label>
            <input 
              type="file" 
              id="mixArtistImageInput" 
              accept=".jpg,.jpeg,.png,.gif,.webp,image/*"
              style="width: 100%; padding: 0.75rem; border: 2px solid var(--color-yellow-75); border-radius: 5px; background: #0a0a0a; color: var(--color-yellow-75); font-family: var(--font-mathias);"
            />
            <p style="color: #888; font-size: 0.75rem; margin-top: 0.25rem;">
              Upload an image for the new artist (.jpg, .png, .gif, .webp)
            </p>
          </div>
          
          <div>
            <label style="display: block; color: var(--color-yellow-75); font-family: var(--font-mathias); margin-bottom: 0.5rem; font-size: 0.875rem;">
              Upload Type
            </label>
            <div style="display: flex; gap: 1rem;">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem 1rem; background: #1a1a1a; border: 2px solid var(--color-yellow-75); border-radius: 5px; flex: 1;">
                <input type="radio" name="uploadType" value="file" checked onchange="toggleMixUploadType('file')" style="accent-color: var(--color-yellow-75);"/>
                <span style="color: var(--color-yellow-75); font-family: var(--font-mathias); font-size: 0.875rem;">Upload File</span>
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.5rem 1rem; background: #1a1a1a; border: 2px solid var(--color-yellow-75); border-radius: 5px; flex: 1;">
                <input type="radio" name="uploadType" value="url" onchange="toggleMixUploadType('url')" style="accent-color: var(--color-yellow-75);"/>
                <span style="color: var(--color-yellow-75); font-family: var(--font-mathias); font-size: 0.875rem;">Use URL</span>
              </label>
            </div>
          </div>
          
          <div id="mixFileUploadContainer">
            <label style="display: block; color: var(--color-yellow-75); font-family: var(--font-mathias); margin-bottom: 0.5rem; font-size: 0.875rem;">
              Audio File (.mp3) <span style="color: #ef4444;">*</span>
            </label>
            <input 
              type="file" 
              id="mixFileInput" 
              accept=".mp3,audio/mpeg"
              onchange="updateMixCostEstimate()"
              style="width: 100%; padding: 0.75rem; border: 2px solid var(--color-yellow-75); border-radius: 5px; background: #0a0a0a; color: var(--color-yellow-75); font-family: var(--font-mathias);"
            />
            <p style="color: #888; font-size: 0.75rem; margin-top: 0.25rem;">
              Max file size: 500MB. File will be uploaded to Arweave.
            </p>
            <div id="mixCostEstimate" style="display: none; margin-top: 0.75rem; padding: 0.75rem; background: #1a1a1a; border: 1px solid var(--color-yellow-75); border-radius: 5px;">
              <div style="color: var(--color-yellow-75); font-family: var(--font-mathias); font-size: 0.875rem; font-weight: bold; margin-bottom: 0.25rem;">üí∞ Upload Cost Estimate:</div>
              <div id="mixCostDetails" style="color: #888; font-family: var(--font-mathias); font-size: 0.75rem;"></div>
            </div>
          </div>
          
          <div id="mixUrlContainer" style="display: none;">
            <label style="display: block; color: var(--color-yellow-75); font-family: var(--font-mathias); margin-bottom: 0.5rem; font-size: 0.875rem;">
              Arweave URL <span style="color: #ef4444;">*</span>
            </label>
            <input 
              type="url" 
              id="mixUrlInput" 
              placeholder="https://arweave.net/..."
              style="width: 100%; padding: 0.75rem; border: 2px solid var(--color-yellow-75); border-radius: 5px; background: #0a0a0a; color: var(--color-yellow-75); font-family: var(--font-mathias);"
            />
            <p style="color: #888; font-size: 0.75rem; margin-top: 0.25rem;">
              Using existing Arweave URL - no upload cost.
            </p>
          </div>
          
          <div>
            <label style="display: block; color: var(--color-yellow-75); font-family: var(--font-mathias); margin-bottom: 0.5rem; font-size: 0.875rem;">
              Mix/Track Title
            </label>
            <input 
              type="text" 
              id="mixTitleInput" 
              placeholder="Enter mix or track title"
              style="width: 100%; padding: 0.75rem; border: 2px solid var(--color-yellow-75); border-radius: 5px; background: #0a0a0a; color: var(--color-yellow-75); font-family: var(--font-mathias);"
            />
          </div>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
              <label style="display: block; color: var(--color-yellow-75); font-family: var(--font-mathias); margin-bottom: 0.5rem; font-size: 0.875rem;">
                Date/Year
              </label>
              <input 
                type="text" 
                id="mixDateInput" 
                placeholder="'24 or 2024"
                style="width: 100%; padding: 0.75rem; border: 2px solid var(--color-yellow-75); border-radius: 5px; background: #0a0a0a; color: var(--color-yellow-75); font-family: var(--font-mathias);"
              />
            </div>
            <div>
              <label style="display: block; color: var(--color-yellow-75); font-family: var(--font-mathias); margin-bottom: 0.5rem; font-size: 0.875rem;">
                Duration
              </label>
              <input 
                type="text" 
                id="mixDurationInput" 
                placeholder="60:00 or 1 hour"
                style="width: 100%; padding: 0.75rem; border: 2px solid var(--color-yellow-75); border-radius: 5px; background: #0a0a0a; color: var(--color-yellow-75); font-family: var(--font-mathias);"
              />
            </div>
          </div>
          
          <div>
            <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.75rem; background: #1a1a1a; border: 2px solid var(--color-yellow-75); border-radius: 5px;">
              <input 
                type="checkbox" 
                id="mixIsTrack" 
                style="width: 20px; height: 20px; cursor: pointer; accent-color: var(--color-yellow-75);"
              />
              <span style="color: var(--color-yellow-75); font-family: var(--font-mathias); font-weight: bold; font-size: 0.875rem;">
                This is a track (not a mix)
              </span>
            </label>
          </div>
          
          <div id="mixUploadProgress" style="display: none;">
            <div style="background: #0a0a0a; border: 2px solid var(--color-yellow-75); border-radius: 5px; padding: 1rem;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                <span style="color: var(--color-yellow-75); font-family: var(--font-mathias); font-size: 0.875rem; font-weight: bold;">Uploading...</span>
                <span id="mixUploadPercent" style="color: var(--color-yellow-75); font-family: var(--font-mathias); font-size: 0.875rem;">0%</span>
              </div>
              <div style="background: #1a1a1a; border: 1px solid var(--color-yellow-75); border-radius: 3px; height: 12px; overflow: hidden;">
                <div id="mixUploadProgressBar" style="background: var(--color-yellow-75); height: 100%; width: 0%; transition: width 0.3s;"></div>
              </div>
              <div id="mixUploadStatus" style="color: #888; font-family: var(--font-mathias); font-size: 0.7rem; margin-top: 0.5rem;">Preparing upload...</div>
            </div>
          </div>
          
          <div id="mixUploadStatusMsg" style="display: none; padding: 1rem; border-radius: 5px; margin-bottom: 1rem;"></div>
          
          <div style="display: flex; gap: 1rem;">
            <button 
              type="submit" 
              id="mixUploadSubmitBtn"
              style="flex: 1; padding: 0.75rem; background: var(--color-yellow-75); color: black; border: none; border-radius: 5px; font-family: var(--font-mathias); font-weight: bold; cursor: pointer;"
            >
              Upload to Arweave
            </button>
            <button 
              type="button" 
              onclick="hideUploadMixModal()"
              style="flex: 1; padding: 0.75rem; background: transparent; color: var(--color-yellow-75); border: 2px solid var(--color-yellow-75); border-radius: 5px; font-family: var(--font-mathias); font-weight: bold; cursor: pointer;"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Upload Artist Image Modal -->
    <div id="artistImageModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center;">
      <div style="background: radial-gradient(ellipse at center, rgba(20, 20, 30, 0.7) 0%, rgba(0, 0, 0, 0.6) 100%); border: 2px solid var(--color-yellow-75); border-radius: 10px; padding: 2rem; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
          <h2 style="color: var(--color-yellow-75); font-family: var(--font-mathias); font-size: 1.5rem; margin: 0;">UPLOAD ARTIST IMAGE</h2>
          <button onclick="hideArtistImageModal()" style="background: transparent; border: none; color: var(--color-yellow-75); font-size: 1.5rem; cursor: pointer; padding: 0; width: 30px; height: 30px;">&times;</button>
        </div>
        
        <form id="artistImageForm" onsubmit="handleArtistImageUpload(event)" style="display: flex; flex-direction: column; gap: 1rem;">
          <!-- Artist Selection -->
          <div>
            <label style="display: block; color: var(--color-yellow-75); font-family: var(--font-mathias); margin-bottom: 0.5rem; font-size: 0.875rem;">
              Artist <span style="color: #ef4444;">*</span>
            </label>
            <select 
              id="imageArtistSelect"
              onchange="handleImageArtistChange()"
              required
              style="width: 100%; padding: 0.75rem; background: rgba(0,0,0,0.3); border: 1px solid var(--color-yellow-75); border-radius: 5px; color: white; font-family: var(--font-body);"
            >
              <option value="">Select an artist...</option>
              <option value="__NEW__">+ New Artist</option>
            </select>
          </div>

          <!-- New Artist Fields (hidden by default) -->
          <div id="newArtistFields" style="display: none;">
            <div style="margin-bottom: 1rem;">
              <label style="display: block; color: var(--color-yellow-75); font-family: var(--font-mathias); margin-bottom: 0.5rem; font-size: 0.875rem;">
                New Artist Name <span style="color: #ef4444;">*</span>
              </label>
              <input 
                type="text" 
                id="newArtistNameInput"
                placeholder="e.g. DJ EXAMPLE"
                style="width: 100%; padding: 0.75rem; background: rgba(0,0,0,0.3); border: 1px solid var(--color-yellow-75); border-radius: 5px; color: white; font-family: var(--font-body);"
              />
            </div>
            <div>
              <label style="display: block; color: var(--color-yellow-75); font-family: var(--font-mathias); margin-bottom: 0.5rem; font-size: 0.875rem;">
                Genre <span style="color: #ef4444;">*</span>
              </label>
              <select 
                id="newArtistGenreSelect"
                style="width: 100%; padding: 0.75rem; background: rgba(0,0,0,0.3); border: 1px solid var(--color-yellow-75); border-radius: 5px; color: white; font-family: var(--font-body);"
              >
                <option value="house">House</option>
                <option value="techno">Techno</option>
                <option value="acid">Acid</option>
                <option value="electronic">Electronic</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>

          <!-- Image File -->
          <div>
            <label style="display: block; color: var(--color-yellow-75); font-family: var(--font-mathias); margin-bottom: 0.5rem; font-size: 0.875rem;">
              Image File (.jpg, .png, .gif, .webp) <span style="color: #ef4444;">*</span>
            </label>
            <input 
              type="file" 
              id="artistImageFileInput" 
              accept=".jpg,.jpeg,.png,.gif,.webp"
              required
              style="width: 100%; padding: 0.75rem; background: rgba(0,0,0,0.3); border: 1px solid var(--color-yellow-75); border-radius: 5px; color: white;"
            />
            <p style="color: #888; font-size: 0.75rem; margin-top: 0.25rem;">Max file size: 50MB. File will be uploaded to Arweave.</p>
          </div>

          <!-- Main Thumbnail Checkbox -->
          <div style="padding: 1rem; background: rgba(0,0,0,0.3); border: 1px solid var(--color-yellow-75); border-radius: 5px;">
            <label style="display: flex; align-items: center; gap: 0.75rem; color: white; cursor: pointer;">
              <input 
                type="checkbox" 
                id="isMainThumbnail" 
                checked
                style="width: 20px; height: 20px; accent-color: var(--color-yellow-75);"
              />
              <span style="font-family: var(--font-body);">This is the main artist thumbnail</span>
            </label>
            <p style="color: #888; font-size: 0.75rem; margin-top: 0.5rem; margin-left: 2rem;">
              If checked, this image will be shown on the homepage and artist page. If unchecked, it will just be added to the artist's folder.
            </p>
          </div>

          <!-- Progress -->
          <div id="imageUploadProgress" style="display: none;">
            <div style="background: rgba(0,0,0,0.3); border-radius: 5px; overflow: hidden;">
              <div id="imageProgressBar" style="width: 0%; height: 8px; background: var(--color-yellow-75); transition: width 0.3s;"></div>
            </div>
            <p id="imageProgressText" style="color: var(--color-yellow-75); text-align: center; margin-top: 0.5rem; font-size: 0.875rem;">Uploading...</p>
          </div>

          <!-- Status Message -->
          <div id="imageUploadStatus" style="display: none; padding: 1rem; border-radius: 5px;"></div>

          <!-- Buttons -->
          <div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
            <button 
              type="submit" 
              id="imageUploadBtn"
              style="flex: 1; padding: 1rem; background: rgba(0,0,0,0.5); border: 2px solid var(--color-yellow-75); border-radius: 5px; color: var(--color-yellow-75); font-family: var(--font-mathias); font-weight: bold; cursor: pointer; font-size: 1rem;"
            >
              Upload to Arweave
            </button>
            <button 
              type="button" 
              onclick="hideArtistImageModal()"
              style="flex: 1; padding: 1rem; background: transparent; border: 2px solid var(--color-yellow-75); border-radius: 5px; color: var(--color-yellow-75); font-family: var(--font-mathias); font-weight: bold; cursor: pointer; font-size: 1rem;"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Deploy Website Modal -->
    <div id="deployModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center;">
      <div style="background: radial-gradient(ellipse at center, rgba(20, 20, 30, 0.7) 0%, rgba(0, 0, 0, 0.6) 100%); border: 2px solid var(--color-yellow-75); border-radius: 10px; padding: 2rem; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
          <h2 id="deployModalTitle" style="color: var(--color-yellow-75); font-family: var(--font-mathias); font-size: 1.5rem; margin: 0;">DEPLOY WEBSITE</h2>
          <button onclick="hideDeployModal()" style="background: transparent; border: none; color: var(--color-yellow-75); font-size: 1.5rem; cursor: pointer; padding: 0; width: 30px; height: 30px;">&times;</button>
        </div>
        <div id="deployModalContent" style="color: var(--color-yellow-75);">
          <!-- Content will be dynamically set -->
        </div>
      </div>
    </div>

    <!-- Upload Modal -->
    <div id="uploadModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center;">
      <div style="background: radial-gradient(ellipse at center, rgba(20, 20, 30, 0.7) 0%, rgba(0, 0, 0, 0.6) 100%); border: 2px solid var(--color-yellow-75); border-radius: 10px; padding: 2rem; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
          <h2 style="color: var(--color-yellow-75); font-family: var(--font-mathias); font-size: 1.5rem; margin: 0;">UPLOAD VIDEO</h2>
          <button onclick="hideUploadModal()" style="background: transparent; border: none; color: var(--color-yellow-75); font-size: 1.5rem; cursor: pointer; padding: 0; width: 30px; height: 30px;">&times;</button>
        </div>
        
        <form id="uploadForm" onsubmit="handleVideoUpload(event)" style="display: flex; flex-direction: column; gap: 1rem;">
          <div>
            <label style="display: block; color: var(--color-yellow-75); font-family: var(--font-mathias); margin-bottom: 0.5rem; font-size: 0.875rem;">
              Select Video Files (.mov, .mp4, .m4v) - Multiple files supported
            </label>
            <input 
              type="file" 
              id="videoFileInput" 
              accept="video/*,.mov,.mp4,.m4v" 
              multiple
              required
              style="width: 100%; padding: 0.75rem; border: 2px solid var(--color-yellow-75); border-radius: 5px; background: #0a0a0a; color: var(--color-yellow-75); font-family: var(--font-mathias);"
            />
            <p style="color: #888; font-size: 0.75rem; margin-top: 0.25rem;">
              Max file size: 500MB per file. Videos will be optimized automatically. You can select multiple files at once.
            </p>
            <div id="selectedFilesList" style="margin-top: 0.75rem; display: none;">
              <p style="color: var(--color-yellow-75); font-family: var(--font-mathias); font-size: 0.75rem; margin-bottom: 0.5rem;">
                Selected files:
              </p>
              <div id="selectedFilesContainer" style="max-height: 150px; overflow-y: auto; border: 1px solid var(--color-yellow-75); border-radius: 5px; padding: 0.5rem; background: #0a0a0a;">
                <!-- Selected files will be listed here -->
              </div>
            </div>
          </div>
          
          <div>
            <label style="display: block; color: var(--color-yellow-75); font-family: var(--font-mathias); margin-bottom: 0.5rem; font-size: 0.875rem;">
              Orientation
            </label>
            <select 
              id="orientationSelect"
              style="width: 100%; padding: 0.75rem; border: 2px solid var(--color-yellow-75); border-radius: 5px; background: #0a0a0a; color: var(--color-yellow-75); font-family: var(--font-mathias);"
            >
              <option value="auto">Auto-detect (maintain aspect ratio)</option>
              <option value="square">Square (720x720)</option>
              <option value="portrait">Portrait (vertical)</option>
              <option value="landscape">Landscape (horizontal)</option>
            </select>
          </div>
          
          <div>
            <label style="display: block; color: var(--color-yellow-75); font-family: var(--font-mathias); margin-bottom: 0.5rem; font-size: 0.875rem;">
              Upload Folder
            </label>
            
            <!-- Folder selection type: existing or new -->
            <div style="display: flex; gap: 1rem; margin-bottom: 0.75rem;">
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: var(--color-yellow-75); font-family: var(--font-mathias); font-size: 0.875rem;">
                <input 
                  type="radio" 
                  name="folderType" 
                  id="folderTypeExisting" 
                  value="existing" 
                  checked
                  onchange="toggleFolderInput()"
                  style="accent-color: var(--color-yellow-75); cursor: pointer;"
                />
                <span>Existing Folder</span>
              </label>
              <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; color: var(--color-yellow-75); font-family: var(--font-mathias); font-size: 0.875rem;">
                <input 
                  type="radio" 
                  name="folderType" 
                  id="folderTypeNew" 
                  value="new"
                  onchange="toggleFolderInput()"
                  style="accent-color: var(--color-yellow-75); cursor: pointer;"
                />
                <span>New Folder</span>
              </label>
            </div>
            
            <!-- Existing folder select -->
            <div id="existingFolderContainer">
              <select 
                id="folderSelect"
                style="width: 100%; padding: 0.75rem; border: 2px solid var(--color-yellow-75); border-radius: 5px; background: #0a0a0a; color: var(--color-yellow-75); font-family: var(--font-mathias); cursor: pointer;"
              >
                <!-- Options will be populated dynamically from API -->
                <option value="">Loading folders...</option>
              </select>
            </div>
            
            <!-- New folder input -->
            <div id="newFolderContainer" style="display: none;">
              <input 
                type="text" 
                id="newFolderName"
                placeholder="Enter folder name (e.g., my-videos)"
                style="width: 100%; padding: 0.75rem; border: 2px solid var(--color-yellow-75); border-radius: 5px; background: #0a0a0a; color: var(--color-yellow-75); font-family: var(--font-mathias);"
                pattern="[a-z0-9-_]+"
                title="Folder name can only contain lowercase letters, numbers, hyphens, and underscores"
              />
              <p style="color: #888; font-size: 0.75rem; margin-top: 0.25rem;">
                Folder name will be converted to lowercase. Use hyphens or underscores for spaces.
              </p>
            </div>
            
            <p id="folderHelpText" style="color: #888; font-size: 0.75rem; margin-top: 0.25rem;">
              Select the folder where your video will be stored
            </p>
          </div>
          
          <div id="uploadProgress" style="display: none;">
            <div style="background: #0a0a0a; border: 2px solid var(--color-yellow-75); border-radius: 5px; padding: 1rem; margin-bottom: 1rem;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 0.75rem;">
                <span style="color: var(--color-yellow-75); font-family: var(--font-mathias); font-size: 0.875rem; font-weight: bold;">Uploading Files...</span>
                <span id="uploadSummary" style="color: var(--color-yellow-75); font-family: var(--font-mathias); font-size: 0.875rem;">0 / 0</span>
              </div>
              <div id="uploadFilesList" style="display: flex; flex-direction: column; gap: 0.75rem;">
                <!-- Individual file progress bars will be added here -->
              </div>
            </div>
          </div>
          
          <div id="uploadStatus" style="display: none; padding: 1rem; border-radius: 5px; margin-bottom: 1rem;"></div>
          
          <div style="display: flex; gap: 1rem;">
            <button 
              type="submit" 
              id="uploadSubmitBtn"
              style="flex: 1; padding: 0.75rem; background: var(--color-yellow-75); color: black; border: none; border-radius: 5px; font-family: var(--font-mathias); font-weight: bold; cursor: pointer;"
            >
              Upload
            </button>
            <button 
              type="button" 
              onclick="hideUploadModal()"
              style="flex: 1; padding: 0.75rem; background: transparent; color: var(--color-yellow-75); border: 2px solid var(--color-yellow-75); border-radius: 5px; font-family: var(--font-mathias); font-weight: bold; cursor: pointer;"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Results Container (for loading/error states) -->
    <div id="resultsContainer" style="padding-left: 1rem; padding-right: 1rem;"></div>
  </main>

  <script>
    // Video generation state
    let activeJobs = new Map(); // jobId -> polling interval
    let videos = []; // Cached video list

    /**
     * System Health Check - checks actual API endpoints
     */
    async function checkSystemHealth() {
      const statuses = {
        videoGen: false,
        arweave: false,
        website: false,
        storage: false
      };

      // Check all endpoints in parallel for speed
      const checks = await Promise.allSettled([
        // Check Video Generation API (/api/videos)
        fetch('/api/videos').then(r => r.ok),
        // Check Arweave/Upload API (/api/upload with GET for cost estimation)
        fetch('/api/upload?fileSize=1000').then(r => r.ok),
        // Check Website deployment API (/api/deploy-website with OPTIONS)
        fetch('/api/deploy-website', { method: 'OPTIONS' }).then(r => r.ok || r.status === 200),
        // Check Artists/Storage API (/api/artists)
        fetch('/api/artists').then(r => r.ok)
      ]);

      statuses.videoGen = checks[0].status === 'fulfilled' && checks[0].value;
      statuses.arweave = checks[1].status === 'fulfilled' && checks[1].value;
      statuses.website = checks[2].status === 'fulfilled' && checks[2].value;
      statuses.storage = checks[3].status === 'fulfilled' && checks[3].value;

      console.log('[Health Check]', statuses);

      // Update UI
      updateStatusIndicator('statusVideoGen', statuses.videoGen);
      updateStatusIndicator('statusArweave', statuses.arweave);
      updateStatusIndicator('statusWebsite', statuses.website);
      updateStatusIndicator('statusStorage', statuses.storage);
    }

    function updateStatusIndicator(elementId, isHealthy) {
      const element = document.getElementById(elementId);
      if (!element) return;
      
      const dot = element.querySelector('.status-dot');
      if (dot) {
        // All indicators: GREEN when healthy, RED when down
        dot.style.background = isHealthy ? '#10b981' : '#ef4444';
      }
    }

    // Check system health on load and every 30 seconds
    document.addEventListener('DOMContentLoaded', () => {
      checkSystemHealth();
      setInterval(checkSystemHealth, 30000);
      // Also load usage indicators
      if (typeof loadStorageUsage === 'function') {
        loadStorageUsage();
      }
      if (typeof loadFirestoreUsage === 'function') {
        loadFirestoreUsage();
      }
    });

    /**
     * Open website (local or Arweave production)
     */
    window.openWebsite = function() {
      // Check if we're on localhost
      const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
      
      if (isLocalhost) {
        // For local testing, use the Python server on port 8080
        window.open('http://localhost:8080/index.html', '_blank');
      } else {
        // For production, check for stored Arweave URL first
        const storedUrl = localStorage.getItem('latestArweaveWebsiteUrl');
        if (storedUrl) {
          window.open(storedUrl, '_blank');
        } else {
          // Fallback to relative path or show message
          showToast('No deployed website URL found. Deploy website first.', 'warning');
        }
      }
    };
    // Video filter settings
    let selectedFilter = 'look_hard_bw_street_doc'; // Default filter
    const filterIntensity = 0.8; // Always use 80% intensity (0.8)
    let selectedAudioSource = 'mixes'; // Default to 'mixes' for one-click generation
    let selectedArtist = 'random'; // Default to 'random' for one-click generation
    let availableArtists = []; // List of available artists
    let selectedFolders = new Set(); // Set of selected folder names
    let availableFolders = []; // List of available folders for current mode
    let enableOverlay = false; // Overlay feature OFF by default
    const VIDEOS_PAGE_SIZE = 8;
    let visibleVideoCount = 0;
    let dismissedVideos = new Set();
    try {
      const storedDismissed = JSON.parse(localStorage.getItem('dismissedVideos') || '[]');
      dismissedVideos = new Set(storedDismissed);
    } catch (err) {
      dismissedVideos = new Set();
    }

    // toggleCollapsible is defined in the head section for early availability

    const getVideoId = (video) => video?.jobId || video?.videoId || video?.id || '';

    function rememberDismissed() {
      try {
        localStorage.setItem('dismissedVideos', JSON.stringify([...dismissedVideos]));
      } catch (err) {
        console.warn('Unable to persist dismissed videos', err);
      }
    }

    window.dismissVideo = function(jobId) {
      if (!jobId) return;
      dismissedVideos.add(jobId);
      rememberDismissed();
      displayVideos(true);
    };

    window.resetDismissedVideos = function() {
      dismissedVideos.clear();
      rememberDismissed();
      displayVideos(true);
    };

    window.loadMoreVideos = function() {
      visibleVideoCount += VIDEOS_PAGE_SIZE;
      displayVideos(false);
    };

    // Video filter definitions (must match backend)
    const VIDEO_FILTERS = {
      'look_gritty_neon_club': { name: 'Gritty Neon Club', description: 'Punchy contrast, slight neon saturation, dirty grain' },
      'look_faded_90s_tape': { name: 'Faded 90s Tape', description: 'Washed, low-contrast tape feel with motion smear' },
      'look_hard_bw_street_doc': { name: 'Hard B&W Street Doc', description: 'Aggro black & white, doc-style club footage' },
      'look_camcorder_ghost': { name: 'Camcorder Ghost', description: 'Cheap DV / camcorder vibe, great for crowd shots' },
      'look_club_cinematic_dirty': { name: 'Club Cinematic Dirty', description: 'Cinematic contrast but still grimy' },
      'look_neon_nightclub': { name: 'Neon Nightclub', description: 'Crushed blacks, neon mids, for laser / LED-heavy shots' },
      'look_zine_posterized_color': { name: 'Zine Posterized Color', description: 'Posterized, graphic, zine / sticker-pack feel' },
      'look_pixel_grit_vertical': { name: 'Pixel Grit', description: 'Low-fi pixelated alley vibe, still readable faces' },
      'look_sodium_streetlight': { name: 'Sodium Streetlight', description: 'Warm orange club/street lighting, gritty and moody' }
    };

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadArtists();
      loadVideos();
      loadAvailableFolders();
      populateUploadFolderSelect();
      loadStorageUsage(); // Load storage usage on page load
      loadFirestoreUsage(); // Load Firestore usage on page load
      // loadFolders is now lazy-loaded when upload section is opened
      
      // Pre-select mixes as default audio source for one-click generation
      setTimeout(() => {
        selectAudioSource('mixes');
      }, 500);
      
      // Refresh usage every 30 seconds
      setInterval(() => {
        loadStorageUsage();
        loadFirestoreUsage();
      }, 30000);
    });

    /**
     * Load available artists from API
     */
    async function loadArtists() {
      try {
        const response = await fetch('/api/artists');
        const data = await response.json();
        
        if (data.success && data.artists) {
          availableArtists = data.artists;
          populateArtistSelect();
          console.log(`‚úÖ Loaded ${availableArtists.length} artists`);
        } else {
          console.warn('‚ö†Ô∏è No artists data available');
        }
      } catch (error) {
        console.error('‚ùå Error loading artists:', error);
      }
    }

    /**
     * Populate artist select dropdown
     */
    function populateArtistSelect() {
      const select = document.getElementById('artistSelect');
      if (!select) return;
      
      // Clear existing options (keep "Random Artist")
      select.innerHTML = '<option value="random">Random Artist</option>';
      
      // Add each artist
      availableArtists.forEach(artist => {
        const option = document.createElement('option');
        option.value = artist.name;
        option.textContent = artist.name;
        select.appendChild(option);
      });
    }

    /**
     * Load available folders from API
     */
    async function loadAvailableFolders() {
      try {
        const response = await fetch('/api/video-folders');
        const data = await response.json();
        
        if (data.success && data.folders) {
          availableFolders = data.folders;
          console.log(`‚úÖ Loaded ${availableFolders.length} folders`);
          // Populate upload folder select when folders are loaded
          populateUploadFolderSelect();
        } else {
          console.warn('‚ö†Ô∏è No folders data available');
        }
      } catch (error) {
        console.error('‚ùå Error loading folders:', error);
      }
    }

    // Store usage data for total cost calculation
    let storageCost = 0;
    let firestoreCost = 0;

    /**
     * Load and display Firebase Storage usage and cost
     */
    async function loadStorageUsage() {
      try {
        const response = await fetch('/api/usage?type=storage');
        const data = await response.json();
        
        // Handle new combined API response format
        const storageData = data.storage || data;
        
        if (data.success || storageData) {
          const usageElement = document.getElementById('storageUsageText');
          const costElement = document.getElementById('storageCostText');
          const dotElement = document.getElementById('storageUsageDot');
          
          // Use storageData if available (new format), otherwise use data (old format)
          const storageInfo = storageData.formatted || data.formatted;
          const storageCostValue = storageData?.estimatedStorageCost ?? data.estimatedStorageCost ?? 0;
          const storagePercentage = storageData?.percentage ?? data.percentage;
          const usedMB = storageData?.usedMB ?? data.usedMB ?? 0;
          const limitMB = storageData?.limitMB ?? data.limitMB ?? 1024;
          
          if (usageElement && dotElement && storageInfo) {
            // Format storage display properly (e.g., "6.3GB/1GB" instead of "6469/1024MB")
            const formatSize = (mb) => {
              if (mb >= 1024) {
                return `${(mb / 1024).toFixed(1)}GB`;
              }
              return `${Math.round(mb)}MB`;
            };
            usageElement.textContent = `${formatSize(usedMB)}/${formatSize(limitMB)}`;
            
            // Store cost for total calculation
            storageCost = storageCostValue;
            
            // Display cost (storage only, monthly estimate)
            if (costElement) {
              if (storageCost > 0) {
                costElement.textContent = `~${storageInfo.cost}/mo`;
                costElement.style.color = storageCost > 1 ? '#ef4444' : '#fbbf24';
              } else {
                costElement.textContent = 'Free';
                costElement.style.color = '#10b981';
              }
            }
            
            // Color code based on usage percentage
            const percentage = storagePercentage;
            let dotColor = '#888888'; // Default gray
            let textColor = 'var(--color-yellow-75)'; // Default yellow
            
            if (percentage >= 90) {
              // Red: Close to limit (>90%)
              dotColor = '#ef4444';
              textColor = '#ef4444';
            } else if (percentage >= 75) {
              // Orange: Approaching limit (>75%)
              dotColor = '#f97316'; // Orange
              textColor = '#f97316';
            } else {
              // Green: Well under limit (<75%)
              dotColor = '#10b981'; // Green
              textColor = 'var(--color-yellow-75)'; // Keep text yellow for consistency
            }
            
            // Update dot color
            dotElement.style.background = dotColor;
            // Update text color
            usageElement.style.color = textColor;
            
            // Update total cost
            updateTotalCost();
          }
        } else {
          const usageElement = document.getElementById('storageUsageText');
          const costElement = document.getElementById('storageCostText');
          const dotElement = document.getElementById('storageUsageDot');
          if (usageElement) {
            usageElement.textContent = 'N/A';
            usageElement.style.color = '#888';
          }
          if (costElement) {
            costElement.textContent = '-';
            costElement.style.color = '#888';
          }
          if (dotElement) {
            dotElement.style.background = '#888888';
          }
          storageCost = 0;
          updateTotalCost();
        }
      } catch (error) {
        console.error('‚ùå Error loading storage usage:', error);
        const usageElement = document.getElementById('storageUsageText');
        const costElement = document.getElementById('storageCostText');
        const dotElement = document.getElementById('storageUsageDot');
        if (usageElement) {
          usageElement.textContent = 'Error';
          usageElement.style.color = '#888';
        }
        if (costElement) {
          costElement.textContent = '-';
          costElement.style.color = '#888';
        }
        if (dotElement) {
          dotElement.style.background = '#888888';
        }
        storageCost = 0;
        updateTotalCost();
      }
    }

    /**
     * Load and display Firestore usage and cost
     */
    async function loadFirestoreUsage() {
      try {
        const response = await fetch('/api/usage?type=firestore');
        const data = await response.json();
        
        // Handle new combined API response format
        const firestoreData = data.firestore || data;
        
        if (data.success || firestoreData) {
          const usageElement = document.getElementById('firestoreUsageText');
          const costElement = document.getElementById('firestoreCostText');
          const dotElement = document.getElementById('firestoreUsageDot');
          
          // Use firestoreData if available (new format), otherwise use data (old format)
          const firestoreInfo = firestoreData.formatted || data.formatted;
          const firestoreCostValue = firestoreData?.estimatedTotalCost ?? data.estimatedTotalCost ?? 0;
          const firestorePercentage = firestoreData?.readsPercentage ?? data.readsPercentage;
          
          if (usageElement && dotElement && firestoreInfo) {
            // Format: "328K/50K/day" (reads/limit)
            usageElement.textContent = `Reads: ${firestoreInfo.readsDisplay}`;
            
            // Store cost for total calculation
            firestoreCost = firestoreCostValue;
            
            // Display cost (monthly estimate)
            if (costElement) {
              if (firestoreCost > 0) {
                costElement.textContent = `~${firestoreInfo.cost}/mo`;
                costElement.style.color = firestoreCost > 3 ? '#ef4444' : firestoreCost > 1 ? '#fbbf24' : '#10b981';
              } else {
                costElement.textContent = '';
                costElement.style.color = '#10b981';
              }
            }
            
            // Color code based on reads percentage (reads are usually the main cost driver)
            const percentage = firestorePercentage;
            let dotColor = '#888888'; // Default gray
            let textColor = 'var(--color-yellow-75)'; // Default yellow
            
            if (percentage >= 90) {
              // Red: Close to limit (>90%)
              dotColor = '#ef4444';
              textColor = '#ef4444';
            } else if (percentage >= 75) {
              // Orange: Approaching limit (>75%)
              dotColor = '#f97316'; // Orange
              textColor = '#f97316';
            } else {
              // Green: Well under limit (<75%)
              dotColor = '#10b981'; // Green
              textColor = 'var(--color-yellow-75)'; // Keep text yellow for consistency
            }
            
            // Update dot color
            dotElement.style.background = dotColor;
            // Update text color
            usageElement.style.color = textColor;
            
            // Update total cost
            updateTotalCost();
          }
        } else {
          const usageElement = document.getElementById('firestoreUsageText');
          const costElement = document.getElementById('firestoreCostText');
          const dotElement = document.getElementById('firestoreUsageDot');
          if (usageElement) {
            usageElement.textContent = 'N/A';
            usageElement.style.color = '#888';
          }
          if (costElement) {
            costElement.textContent = '-';
            costElement.style.color = '#888';
          }
          if (dotElement) {
            dotElement.style.background = '#888888';
          }
          firestoreCost = 0;
          updateTotalCost();
        }
      } catch (error) {
        console.error('‚ùå Error loading Firestore usage:', error);
        const usageElement = document.getElementById('firestoreUsageText');
        const costElement = document.getElementById('firestoreCostText');
        const dotElement = document.getElementById('firestoreUsageDot');
        if (usageElement) {
          usageElement.textContent = 'Error';
          usageElement.style.color = '#888';
        }
        if (costElement) {
          costElement.textContent = '-';
          costElement.style.color = '#888';
        }
        if (dotElement) {
          dotElement.style.background = '#888888';
        }
        firestoreCost = 0;
        updateTotalCost();
      }
    }

    /**
     * Update total cost indicator (removed - no longer displayed)
     */
    function updateTotalCost() {
      // Total cost display removed per user request
      return;
    }

    /**
     * Populate upload folder select dropdown with all available folders
     */
    function populateUploadFolderSelect() {
      const folderSelect = document.getElementById('folderSelect');
      if (!folderSelect || availableFolders.length === 0) return;
      
      // Clear existing options
      folderSelect.innerHTML = '';
      
      // Add all folders as options
      availableFolders.forEach(folder => {
        const option = document.createElement('option');
        option.value = folder.name;
        
        // Get display name (remove 'assets/' prefix for display)
        const displayName = folder.displayName || folder.name.replace('assets/', '').replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        
        option.textContent = `${displayName} (${folder.count || 0} videos)`;
        folderSelect.appendChild(option);
      });
      
      // Set default to first folder
      if (folderSelect.options.length > 0) {
        folderSelect.value = availableFolders[0].name;
      }
      
      console.log(`‚úÖ Populated upload folder select with ${availableFolders.length} folders`);
    }

    /**
     * Select audio source (MIXES or TRACKS)
     */
    window.selectAudioSource = function(source) {
      selectedAudioSource = source;
      
      const mixesBtn = document.getElementById('audioSourceMixes');
      const tracksBtn = document.getElementById('audioSourceTracks');
      const artistContainer = document.getElementById('artistSelectionContainer');
      const folderContainer = document.getElementById('folderSelectionContainer');
      const filterContainer = document.getElementById('filterSelectionContainer');
      const overlayContainer = document.getElementById('overlayToggleContainer');
      
      if (source === 'mixes') {
        mixesBtn.style.background = 'var(--color-yellow-75)';
        mixesBtn.style.color = 'black';
        tracksBtn.style.background = '#0a0a0a';
        tracksBtn.style.color = 'var(--color-yellow-75)';
        artistContainer.style.display = 'block';
        folderContainer.style.display = 'block';
      } else {
        tracksBtn.style.background = 'var(--color-yellow-75)';
        tracksBtn.style.color = 'black';
        mixesBtn.style.background = '#0a0a0a';
        mixesBtn.style.color = 'var(--color-yellow-75)';
        artistContainer.style.display = 'none';
        folderContainer.style.display = 'block';
        selectedArtist = 'random'; // Reset to random for tracks
      }
      
      // overlayContainer is already defined above, no need to redeclare
      // Show overlay toggle when folders are shown
      if (overlayContainer) {
        overlayContainer.style.display = 'block';
      }
      
      // Show ALL available folders for both modes
      populateAllFolderCheckboxes();
      
      console.log(`‚úÖ Selected audio source: ${source}`);
    };

    /**
     * Populate folder checkboxes with ALL available folders
     */
    function populateAllFolderCheckboxes() {
      const container = document.getElementById('folderCheckboxes');
      container.innerHTML = '';
      selectedFolders.clear();
      
      // Map folder names to display names (includes all folders)
      const folderDisplayMap = {
        'equipment': 'Equipment',
        'decks': 'Decks',
        'skyline': 'Skyline',
        'chicago-skyline-videos': 'Chicago Skyline',
        'neighborhood': 'Neighborhood',
        'artist': 'Artist',
        'family': 'Family'
      };
      
      // Use all available folders from the API
      if (availableFolders.length === 0) {
        console.warn('‚ö†Ô∏è No folders loaded yet, loading folders...');
        loadAvailableFolders().then(() => {
          populateAllFolderCheckboxes();
        });
        return;
      }
      
      availableFolders.forEach(folderInfo => {
        // Skip logos, paper_backgrounds, and mixes/Baiee folders (internal use only, not for user selection)
        if (folderInfo.name === 'logos' || folderInfo.name === 'paper_backgrounds' || folderInfo.name === 'mixes/Baiee' || folderInfo.name === 'mixes' || folderInfo.name.includes('Baiee')) {
          return;
        }
        
        // Normalize folder name (remove 'assets/' prefix for display)
        const folderName = folderInfo.name.replace('assets/', '');
        const displayName = folderDisplayMap[folderName] || folderName.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        const count = folderInfo.count || 0;
        const actualFolderName = folderInfo.name; // Use the actual folder name from API
        
        // Create folder item without checkbox - styled like other folder selection UI
        const folderItem = document.createElement('div');
        folderItem.className = 'folder-select-item selected';
        folderItem.style.cssText = `
          cursor: pointer;
          width: 100%;
        `;
        selectedFolders.add(actualFolderName);
        
        folderItem.addEventListener('click', () => {
          if (selectedFolders.has(actualFolderName)) {
            selectedFolders.delete(actualFolderName);
            folderItem.classList.remove('selected');
            folderItem.classList.add('unselected');
          } else {
            selectedFolders.add(actualFolderName);
            folderItem.classList.remove('unselected');
            folderItem.classList.add('selected');
          }
          console.log(`‚úÖ Selected folders:`, Array.from(selectedFolders));
        });
        
        const folderNameDiv = document.createElement('div');
        folderNameDiv.className = 'folder-name';
        folderNameDiv.style.cssText = `
          font-family: var(--font-mathias);
          color: var(--color-yellow-75);
          font-weight: bold;
          margin-bottom: 0.25rem;
        `;
        folderNameDiv.textContent = displayName;
        
        const folderCountDiv = document.createElement('div');
        folderCountDiv.className = 'folder-count';
        folderCountDiv.style.cssText = `
          font-size: 0.75rem;
          color: #888;
        `;
        folderCountDiv.textContent = `${count} video${count !== 1 ? 's' : ''}`;
        
        folderItem.appendChild(folderNameDiv);
        folderItem.appendChild(folderCountDiv);
        
        container.appendChild(folderItem);
      });
      
      console.log(`‚úÖ Populated ${availableFolders.length} folder checkboxes (all folders)`);
    }

    /**
     * Handle artist selection change
     */
    document.addEventListener('DOMContentLoaded', () => {
      const artistSelect = document.getElementById('artistSelect');
      if (artistSelect) {
        artistSelect.addEventListener('change', (e) => {
          selectedArtist = e.target.value;
          console.log(`‚úÖ Selected artist: ${selectedArtist}`);
        });
      }
    });

    /**
     * Update filter selection
     */
    window.updateFilterSelection = function(filterValue) {
      selectedFilter = filterValue;
      console.log(`‚úÖ Selected filter: ${selectedFilter}`);
    }

    /**
     * Update overlay toggle state
     */
    function updateOverlayToggle(checked) {
      enableOverlay = checked;
      const overlayContainer = document.getElementById('overlayToggleContainer');
      const label = overlayContainer?.querySelector('label');
      if (label) {
        if (checked) {
          label.style.background = '#2a2a2a';
          label.style.borderColor = 'var(--color-yellow-75)';
        } else {
          label.style.background = '#1a1a1a';
          label.style.borderColor = '#666';
        }
      }
      console.log(`‚úÖ Overlay feature: ${checked ? 'ENABLED' : 'DISABLED'}`);
    }

    /**
     * Initialize filter selection buttons
     * COMMENTED OUT: Always using Hard B&W Street Doc @ 80% intensity
     */
    /*
    function initializeFilterButtons() {
      const container = document.getElementById('filterButtons');
      if (!container) return;

      Object.keys(VIDEO_FILTERS).forEach(filterKey => {
        const filter = VIDEO_FILTERS[filterKey];
        const button = document.createElement('button');
        button.type = 'button';
        button.dataset.filterKey = filterKey;
        button.className = 'filter-btn';
        button.style.cssText = `
          padding: 0.75rem 1rem;
          border: 2px solid var(--color-yellow-75);
          border-radius: 5px;
          background: #0a0a0a;
          color: var(--color-yellow-75);
          font-family: var(--font-mathias);
          font-size: 0.875rem;
          font-weight: bold;
          cursor: pointer;
          transition: all 0.3s ease;
          text-align: left;
        `;
        button.innerHTML = `
          <div style="font-weight: bold; margin-bottom: 0.25rem;">${filter.name}</div>
          <div style="font-size: 0.75rem; opacity: 0.8; font-weight: normal;">${filter.description}</div>
        `;
        
        button.addEventListener('click', () => selectFilter(filterKey));
        container.appendChild(button);
      });
    }

    function selectFilter(filterKey) {
      selectedFilter = filterKey;
      
      // Update button styles
      document.querySelectorAll('.filter-btn').forEach(btn => {
        if (btn.dataset.filterKey === filterKey) {
          btn.style.background = 'var(--color-yellow-75)';
          btn.style.color = 'black';
          btn.style.borderColor = 'var(--color-yellow-75)';
        } else {
          btn.style.background = '#0a0a0a';
          btn.style.color = 'var(--color-yellow-75)';
          btn.style.borderColor = 'var(--color-yellow-75)';
        }
      });
      
      // Show intensity slider
      const intensityContainer = document.getElementById('filterIntensityContainer');
      if (intensityContainer) {
        intensityContainer.style.display = 'block';
      }
      
      console.log(`‚úÖ Selected filter: ${VIDEO_FILTERS[filterKey].name}`);
    }

    function updateFilterIntensity(value) {
      filterIntensity = parseFloat(value) / 100; // Convert 0-100 to 0.0-1.0
      const intensityValue = document.getElementById('filterIntensityValue');
      if (intensityValue) {
        intensityValue.textContent = `${value}%`;
      }
      console.log(`‚úÖ Filter intensity: ${value}%`);
    }
    */

    /**
     * Generate a new video
     */
    window.generateVideo = async function() {
      // Check if audio source is selected
      if (!selectedAudioSource) {
        showToast('Please select an audio source (MIXES or TRACKS) first!', 'error');
        return;
      }
      
      // Check if at least one folder is selected
      if (selectedFolders.size === 0) {
        showToast('Please select at least one video folder!', 'error');
        return;
      }
      
      // Filter check removed - always using Hard B&W Street Doc @ 80%

      const btn = document.getElementById('generateVideoBtn');
      const btnText = document.getElementById('generateBtnText');
      const btnLoading = document.getElementById('generateBtnLoading');
      
      // Disable button and show loading
      btn.disabled = true;
      btnText.style.display = 'none';
      btnLoading.style.display = 'inline';

      try {
        // Prepare request body
        // Always use Hard B&W Street Doc filter at 80% intensity
        const requestBody = {
          duration: 30,
          videoFilter: selectedFilter, // Always 'look_hard_bw_street_doc'
          filterIntensity: filterIntensity, // Always 0.8 (80%)
          useTrax: selectedAudioSource === 'tracks', // true for tracks, false for mixes
          selectedFolders: Array.from(selectedFolders), // Array of selected folder names
          enableOverlay: enableOverlay // Overlay feature toggle
        };
        
        // Add artist selection only for mixes
        if (selectedAudioSource === 'mixes') {
          requestBody.artist = selectedArtist || 'random';
        } else {
          // For tracks, always use random (or BAI-EE if available)
          requestBody.artist = 'random';
        }

        // Call API to create job
        const response = await fetch('/api/generate-video', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody)
        });

        const data = await response.json();

        if (data.success) {
          console.log('‚úÖ Video generation job created:', data.jobId);
          
          // Add video to the list immediately with pending status
          const newVideo = {
            jobId: data.jobId,
            videoId: data.jobId,
            artist: requestBody.artist || 'Random',
            mixTitle: 'Processing...',
            duration: 30,
            status: 'pending',
            videoUrl: null,
            createdAt: new Date().toISOString()
          };
          
          // Add to videos array at the top
          videos.unshift(newVideo);
          
          // Display the updated list
          displayVideos(true);
          
          // Scroll to the videos table to show the processing video
          setTimeout(() => {
            const videosTable = document.getElementById('videosTable');
            if (videosTable) {
              // Scroll to the first row (the new video)
              const firstRow = videosTable.querySelector('tr');
              if (firstRow) {
                firstRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }
            }
          }, 300);
          
          // Add to active jobs and start polling
          startPollingJob(data.jobId);
          
          // Show success message
          showToast('Video generation started! Processing...', 'success');
        } else {
          throw new Error(data.error || 'Failed to create video job');
        }

      } catch (error) {
        console.error('‚ùå Error generating video:', error);
        showToast('Failed to start video generation: ' + error.message, 'error');
      } finally {
        // Re-enable button
        btn.disabled = false;
        btnText.style.display = 'inline';
        btnLoading.style.display = 'none';
      }
    }

    /**
     * Start polling for job status
     */
    function startPollingJob(jobId) {
      // Clear any existing polling for this job
      if (activeJobs.has(jobId)) {
        clearInterval(activeJobs.get(jobId));
      }

      // Poll every 2 seconds
      const interval = setInterval(async () => {
        try {
          const response = await fetch(`/api/video-status?jobId=${jobId}`);
          const data = await response.json();

          if (data.success) {
            // Update row in table
            updateVideoRowStatus(jobId, data.status, data.videoUrl, data.error);

            // If completed or failed, stop polling
            if (data.status === 'completed' || data.status === 'failed') {
              clearInterval(interval);
              activeJobs.delete(jobId);
              
              // Reload videos list after a short delay to ensure backend has updated
              if (data.status === 'completed') {
                setTimeout(() => {
                  loadVideos();
                }, 1000); // 1 second delay
              }
            }
          }
        } catch (error) {
          console.error(`Error polling job ${jobId}:`, error);
        }
      }, 2000);

      activeJobs.set(jobId, interval);
    }

    /**
     * Load all videos from API
     */
    window.loadVideos = async function() {
      const headerLoadingState = document.getElementById('headerLoadingState');
      const logoGif = document.getElementById('logoGif');
      const resultsContainer = document.getElementById('resultsContainer');
      const errorState = document.getElementById('errorState');

      // Show loading spinner in header, hide gif
      if (headerLoadingState && logoGif) {
        logoGif.style.display = 'none';
        headerLoadingState.style.display = 'flex';
      }
      
      resultsContainer.style.display = 'none';
      errorState.classList.add('hidden');

      try {
        const response = await fetch('/api/videos');
        const data = await response.json();

        if (data.success) {
          videos = data.videos || [];
          console.log(`üìπ Loaded ${videos.length} videos from API`);
          console.log(`üìπ Raw API response sample:`, videos[0]);
          
          // Sort videos by creation date (newest first)
          videos.sort((a, b) => {
            const dateA = new Date(a.createdAt || 0);
            const dateB = new Date(b.createdAt || 0);
            return dateB - dateA; // Newest first
          });
          
          // Normalize videoUrl - ensure it's always a string or null
          videos = videos.map(v => {
            // If videoUrl is an object, try to extract the URL
            if (v.videoUrl && typeof v.videoUrl === 'object') {
              console.warn(`‚ö†Ô∏è Normalizing videoUrl for ${v.jobId}:`, v.videoUrl);
              v.videoUrl = v.videoUrl.url || v.videoUrl.value || null;
            }
            // Ensure videoUrl is a string or null
            if (v.videoUrl && typeof v.videoUrl !== 'string') {
              v.videoUrl = String(v.videoUrl);
            }
            return v;
          });
          
          console.log(`üìπ Videos with status 'completed':`, videos.filter(v => v.status === 'completed').length);
          console.log(`üìπ Videos with videoUrl:`, videos.filter(v => v.videoUrl).length);
          
          // Log all completed videos with their URLs
          const completedVideos = videos.filter(v => v.status === 'completed');
          console.log(`üìπ All completed videos:`, completedVideos.map(v => ({
            jobId: v.jobId,
            videoUrl: v.videoUrl || 'MISSING',
            videoUrlType: typeof v.videoUrl,
            hasUrl: !!v.videoUrl
          })));
          
          console.log(`üìπ Sample completed video (full):`, videos.find(v => v.status === 'completed' && v.videoUrl));
          displayVideos();
          
          // Resume polling for any pending/processing jobs that aren't being polled yet
          videos.forEach(video => {
            const status = video.status || 'completed';
            if ((status === 'pending' || status === 'processing') && !activeJobs.has(video.jobId)) {
              console.log(`üîÑ Resuming polling for job: ${video.jobId}`);
              startPollingJob(video.jobId);
            }
          });
        } else {
          throw new Error(data.error || 'Failed to load videos');
        }

      } catch (error) {
        console.error('‚ùå Error loading videos:', error);
        showError('Failed to load videos: ' + error.message);
      } finally {
        // Hide loading spinner, show gif again
        const headerLoadingState = document.getElementById('headerLoadingState');
        const logoGif = document.getElementById('logoGif');
        if (headerLoadingState && logoGif) {
          headerLoadingState.style.display = 'none';
          logoGif.style.display = 'block';
        }
        
        resultsContainer.style.display = 'block';
      }
    }

    /**
     * Display videos in table and mobile cards with lazy loading
     */
    function displayVideos(resetVisible = true) {
      const tableBody = document.getElementById('videosTable');
      const mobileList = document.getElementById('videosMobileList');
      const loadMoreBtn = document.getElementById('loadMoreBtn');
      const resetBtn = document.getElementById('resetDismissedBtn');

      if (tableBody) tableBody.innerHTML = '';
      if (mobileList) mobileList.innerHTML = '';

      const filteredVideos = videos.filter(video => !dismissedVideos.has(getVideoId(video)));

      if (resetVisible || visibleVideoCount === 0) {
        visibleVideoCount = Math.min(VIDEOS_PAGE_SIZE, filteredVideos.length || VIDEOS_PAGE_SIZE);
      }
      if (visibleVideoCount > filteredVideos.length) {
        visibleVideoCount = filteredVideos.length;
      }

      if (filteredVideos.length === 0) {
        if (tableBody) {
          tableBody.innerHTML = `
            <tr>
              <td colspan="4" style="text-align: center; padding: 2rem; color: var(--color-yellow-75);">
                No videos available. Generate a video to see it here.
              </td>
            </tr>
          `;
        }
        if (mobileList) {
          mobileList.innerHTML = `
            <div class="video-item-card" style="text-align: center; font-family: var(--font-body);">
              No videos available. Generate a video to see it here.
            </div>
          `;
        }
        if (loadMoreBtn) loadMoreBtn.style.display = 'none';
        if (resetBtn) resetBtn.style.display = dismissedVideos.size ? 'inline-flex' : 'none';
        return;
      }

      // Sort by creation date (newest first)
      const sortedVideos = [...filteredVideos].sort((a, b) => {
        const dateA = new Date(a.createdAt || 0);
        const dateB = new Date(b.createdAt || 0);
        return dateB - dateA;
      });

      const visibleSlice = sortedVideos.slice(0, visibleVideoCount);

      renderVideoTableRows(visibleSlice, tableBody);
      renderMobileVideos(visibleSlice, mobileList);

      const hasMore = sortedVideos.length > visibleSlice.length;
      if (loadMoreBtn) loadMoreBtn.style.display = hasMore ? 'inline-flex' : 'none';
      if (resetBtn) resetBtn.style.display = dismissedVideos.size ? 'inline-flex' : 'none';
    }

    /**
     * Render the desktop table rows
     */
    function renderVideoTableRows(videoList, tableBody) {
      if (!tableBody) return;
      if (videoList.length === 0) return;

      videoList.forEach(video => {
        // Ensure videoUrl is a string, not an object
        if (video.videoUrl && typeof video.videoUrl === 'object') {
          video.videoUrl = null;
        }
        const row = createVideoRow(video);
        tableBody.appendChild(row);
      });
    }

    /**
     * Render the mobile-friendly cards
     */
    function renderMobileVideos(videoList, container) {
      if (!container) return;
      if (videoList.length === 0) return;

      videoList.forEach(video => {
        const videoId = getVideoId(video);
        const statusDisplay = getStatusDisplay(video.status || 'completed');
        const actions = getActionsHtml(video);
        const card = document.createElement('div');
        card.className = 'video-item-card';
        card.innerHTML = `
          <button class="dismiss-chip" onclick="dismissVideo('${videoId}')">&times;</button>
          <div style="font-family: var(--font-mathias); letter-spacing: 0.06em; text-transform: uppercase; color: var(--color-yellow-75); font-size: 1rem;">
            ${video.artist || 'Unknown'}
          </div>
          <div class="video-item-meta">
            <span>Duration: ${video.duration || 30}s</span>
            <span>Status: ${statusDisplay}</span>
          </div>
          <div class="video-item-actions">
            ${actions}
          </div>
        `;
        container.appendChild(card);
      });
    }

    /**
     * Create a table row for a video
     */
    function createVideoRow(video) {
      const row = document.createElement('tr');
      const videoId = getVideoId(video);
      row.id = `video-row-${videoId}`;
      row.className = 'video-row';

      const status = video.status || 'completed';
      const statusDisplay = getStatusDisplay(status);
      const actions = getActionsHtml(video);

      row.innerHTML = `
        <td class="px-2" style="padding: 1rem; text-align: center; color: var(--color-yellow-75); font-family: var(--font-body);">
          ${video.artist || 'Unknown'}
        </td>
        <td class="px-2" style="padding: 1rem; text-align: center; color: var(--color-yellow-75); font-family: var(--font-body);">
          ${video.duration || 30}s
        </td>
        <td class="px-2" style="padding: 1rem; text-align: center;">
          ${statusDisplay}
        </td>
        <td class="px-2" style="padding: 1rem; text-align: center;">
          <div class="video-actions-inline" style="justify-content: center;">
            ${actions}
          </div>
        </td>
      `;

      return row;
    }

    /**
     * Get status display HTML
     */
    function getStatusDisplay(status) {
      const statusMap = {
        'pending': '<span style="color: #fbbf24;">Pending</span>',
        'processing': '<span style="color: #3b82f6;">Processing</span>',
        'completed': '<span style="color: #10b981;">Ready</span>',
        'failed': '<span style="color: #ef4444;">Failed</span>'
      };
      return statusMap[status] || '<span style="color: #6b7280;">Unknown</span>';
    }

    /**
     * Get actions HTML
     */
    function getActionsHtml(video) {
      const videoId = getVideoId(video);
      
      if (video.status === 'completed' && video.videoUrl) {
        const escapedUrl = video.videoUrl.replace(/'/g, "\\'");
        const filename = `${video.artist || 'video'}_${video.duration || 30}s.mp4`.replace(/'/g, "\\'");
        
        return `
          <div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap; width: 100%;">
            <button 
              onclick="viewVideo('${escapedUrl}')" 
              class="btn-base btn-secondary"
              style="flex: 1; width: 100%; background: transparent; color: var(--color-yellow-75); border: 2px solid var(--color-yellow-75); cursor: pointer; font-family: var(--font-mathias); border-radius: 10px; padding: 0.75rem 1rem; font-weight: bold;"
            >
              VIEW
            </button>
            <button 
              onclick="downloadVideo('${escapedUrl}', '${filename}')" 
              class="btn-base btn-secondary"
              style="flex: 1; width: 100%; background: transparent; color: var(--color-yellow-75); border: 2px solid var(--color-yellow-75); cursor: pointer; font-family: var(--font-mathias); border-radius: 10px; padding: 0.75rem 1rem; font-weight: bold;"
            >
              DOWNLOAD
            </button>
          </div>
        `;
      } else if (video.status === 'pending' || video.status === 'processing') {
        return '<span style="color: #6b7280; font-size: 0.9rem; font-family: var(--font-body);">Processing...</span>';
      } else if (video.status === 'failed') {
        return '<span style="color: #ef4444; font-size: 0.9rem; font-family: var(--font-body);">Failed</span>';
      }
      return '<span style="color: #6b7280; font-size: 0.9rem; font-family: var(--font-body);">No actions</span>';
    }

    /**
     * Add video row to table (for new jobs) - DEPRECATED, now handled inline in generateVideo
     */
    function addVideoRowToTable(video) {
      console.warn('addVideoRowToTable is deprecated - video should be added directly in generateVideo');
      const id = getVideoId(video);
      if (id) {
        const existingIndex = videos.findIndex(v => getVideoId(v) === id);
        if (existingIndex >= 0) {
          videos[existingIndex] = { ...videos[existingIndex], ...video };
        } else {
          videos.unshift(video);
        }
      } else {
        videos.unshift(video);
      }
      displayVideos(true);
    }

    /**
     * Update video row status
     */
    function updateVideoRowStatus(jobId, status, videoUrl, error) {
      if (!jobId) return;
      const idx = videos.findIndex(v => getVideoId(v) === jobId);
      if (idx >= 0) {
        videos[idx] = {
          ...videos[idx],
          status,
          videoUrl: videoUrl ?? videos[idx].videoUrl,
          error
        };
      }
      displayVideos(false);
    }

    /**
     * View video in new tab
     */
    window.viewVideo = function(videoUrl) {
      window.open(videoUrl, '_blank');
    };

    /**
     * Download video
     */
    window.downloadVideo = function(videoUrl, filename) {
      const link = document.createElement('a');
      link.href = videoUrl;
      link.download = filename;
      link.click();
    }

    /**
     * Show toast notification
     */
    function showToast(message, type = 'info') {
      // Simple toast implementation
      const toast = document.createElement('div');
      toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 1rem 1.5rem;
        background: ${type === 'error' ? 'var(--color-red-75)' : 'var(--color-yellow-75)'};
        color: ${type === 'error' ? 'white' : 'black'};
        border-radius: 5px;
        font-family: var(--font-body);
        font-size: 0.95rem;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      `;
      toast.textContent = message;
      document.body.appendChild(toast);

      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transition = 'opacity 0.3s';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    /**
     * Show error message
     */
    function showError(message) {
      document.getElementById('errorMessage').textContent = message;
      document.getElementById('errorState').classList.remove('hidden');
    }

    /**
     * Toggle between existing folder select and new folder input
     */
    window.toggleFolderInput = function() {
      const folderTypeExisting = document.getElementById('folderTypeExisting');
      const folderTypeNew = document.getElementById('folderTypeNew');
      const existingFolderContainer = document.getElementById('existingFolderContainer');
      const newFolderContainer = document.getElementById('newFolderContainer');
      const folderHelpText = document.getElementById('folderHelpText');
      
      if (folderTypeNew.checked) {
        existingFolderContainer.style.display = 'none';
        newFolderContainer.style.display = 'block';
        folderHelpText.textContent = 'Enter a name for the new folder. Videos will be uploaded to this folder.';
      } else {
        existingFolderContainer.style.display = 'block';
        newFolderContainer.style.display = 'none';
        folderHelpText.textContent = 'Select the folder where your video will be stored';
      }
    }

    /**
     * Show upload modal
     */
    window.showUploadModal = function() {
      document.getElementById('uploadModal').style.display = 'flex';
      // Reset form
      document.getElementById('uploadForm').reset();
      document.getElementById('uploadProgress').style.display = 'none';
      document.getElementById('uploadStatus').style.display = 'none';
      document.getElementById('selectedFilesList').style.display = 'none';
      document.getElementById('selectedFilesContainer').innerHTML = '';
      // Reset folder type to existing
      document.getElementById('folderTypeExisting').checked = true;
      toggleFolderInput();
    }

    /**
     * Show upload mix modal
     */
    window.showUploadMixModal = async function() {
      document.getElementById('uploadMixModal').style.display = 'flex';
      // Reset form
      document.getElementById('uploadMixForm').reset();
      document.getElementById('mixUploadProgress').style.display = 'none';
      document.getElementById('mixUploadStatusMsg').style.display = 'none';
      toggleMixUploadType('file'); // Reset to file upload
      
      // Load artists into dropdown
      await populateArtistDropdown();
      handleArtistSelection(); // Reset artist selection UI
    }
    
    /**
     * Populate artist dropdown
     */
    async function populateArtistDropdown() {
      try {
        console.log('[Mix Upload] Loading artists for dropdown...');
        const response = await fetch('/api/artists');
        const data = await response.json();
        
        console.log('[Mix Upload] Artists API response:', data);
        
        const select = document.getElementById('mixArtistSelect');
        if (!select) {
          console.error('[Mix Upload] mixArtistSelect element not found!');
          return;
        }
        
        // Clear existing options except "Select" and "New"
        while (select.children.length > 2) {
          select.removeChild(select.lastChild);
        }
        
        if (data.success && data.artists && Array.isArray(data.artists)) {
          console.log(`[Mix Upload] Found ${data.artists.length} artists to add`);
          data.artists.forEach(artist => {
            const option = document.createElement('option');
            // API returns 'name' property, not 'artistName'
            const artistName = artist.name || artist.artistName || 'Unknown';
            option.value = artistName;
            option.textContent = artistName;
            select.appendChild(option);
          });
          console.log(`[Mix Upload] ‚úÖ Added ${data.artists.length} artists to dropdown`);
        } else {
          console.warn('[Mix Upload] No artists found in API response:', data);
        }
      } catch (error) {
        console.error('[Mix Upload] Error loading artists:', error);
      }
    }
    
    /**
     * Handle artist selection change
     */
    function handleArtistSelection() {
      const select = document.getElementById('mixArtistSelect');
      const nameInput = document.getElementById('mixArtistName');
      const imageContainer = document.getElementById('mixArtistImageContainer');
      const imageInput = document.getElementById('mixArtistImageInput');
      
      if (select.value === '__new__') {
        // New artist - show name input and require image
        nameInput.style.display = 'block';
        nameInput.required = true;
        imageContainer.style.display = 'block';
        imageInput.required = true;
        nameInput.value = '';
        imageInput.value = '';
      } else if (select.value) {
        // Existing artist - hide name input and image
        nameInput.style.display = 'none';
        nameInput.required = false;
        imageContainer.style.display = 'none';
        imageInput.required = false;
        nameInput.value = select.value;
      } else {
        // No selection
        nameInput.style.display = 'none';
        nameInput.required = false;
        imageContainer.style.display = 'none';
        imageInput.required = false;
        nameInput.value = '';
      }
    }

    /**
     * Hide upload mix modal
     */
    window.hideUploadMixModal = function() {
      document.getElementById('uploadMixModal').style.display = 'none';
    };

    // =====================================================
    // Artist Image Upload Modal Functions
    // =====================================================

    /**
     * Show artist image upload modal
     */
    window.showArtistImageModal = async function() {
      document.getElementById('artistImageModal').style.display = 'flex';
      resetArtistImageModal();
      await loadArtistsForImageModal();
    };

    /**
     * Hide artist image modal
     */
    window.hideArtistImageModal = function() {
      document.getElementById('artistImageModal').style.display = 'none';
      resetArtistImageModal();
    };

    /**
     * Reset the artist image modal state
     */
    function resetArtistImageModal() {
      document.getElementById('artistImageForm').reset();
      document.getElementById('newArtistFields').style.display = 'none';
      document.getElementById('imageUploadProgress').style.display = 'none';
      document.getElementById('imageUploadStatus').style.display = 'none';
      document.getElementById('imageUploadBtn').disabled = false;
    }

    /**
     * Load artists for the artist dropdown
     */
    async function loadArtistsForImageModal() {
      try {
        const response = await fetch('/api/artists');
        const data = await response.json();
        if (data.success && data.artists && data.artists.length > 0) {
          const select = document.getElementById('imageArtistSelect');
          // Keep the first two options (placeholder and New Artist)
          select.innerHTML = '<option value="">Select an artist...</option><option value="__NEW__">+ New Artist</option>';
          // Add existing artists - API returns 'name' not 'artistName'
          data.artists.forEach(artist => {
            const option = document.createElement('option');
            const artistName = artist.name || artist.artistName;
            option.value = artistName;
            option.textContent = artistName;
            select.appendChild(option);
          });
          console.log(`[Image Upload] Loaded ${data.artists.length} artists`);
        } else {
          console.warn('[Image Upload] No artists returned from API');
        }
      } catch (error) {
        console.error('Failed to load artists:', error);
      }
    }

    /**
     * Handle artist selection change
     */
    window.handleImageArtistChange = function() {
      const select = document.getElementById('imageArtistSelect');
      const newArtistFields = document.getElementById('newArtistFields');
      const newArtistNameInput = document.getElementById('newArtistNameInput');
      
      if (select.value === '__NEW__') {
        newArtistFields.style.display = 'block';
        newArtistNameInput.required = true;
      } else {
        newArtistFields.style.display = 'none';
        newArtistNameInput.required = false;
      }
    };

    /**
     * Handle artist image upload form submission
     */
    window.handleArtistImageUpload = async function(event) {
      event.preventDefault();
      
      const select = document.getElementById('imageArtistSelect');
      const fileInput = document.getElementById('artistImageFileInput');
      const isMainThumbnail = document.getElementById('isMainThumbnail').checked;
      const uploadBtn = document.getElementById('imageUploadBtn');
      
      // Determine artist name
      let artistName = '';
      let isNewArtist = false;
      let genre = 'electronic';
      
      if (select.value === '__NEW__') {
        artistName = document.getElementById('newArtistNameInput').value.trim();
        genre = document.getElementById('newArtistGenreSelect').value;
        isNewArtist = true;
        
        if (!artistName) {
          showToast('Please enter a new artist name', 'error');
          return;
        }
      } else if (select.value) {
        artistName = select.value;
      } else {
        showToast('Please select an artist', 'error');
        return;
      }
      
      if (!fileInput.files || fileInput.files.length === 0) {
        showToast('Please select an image file', 'error');
        return;
      }
      
      // Disable button and show progress
      uploadBtn.disabled = true;
      uploadBtn.textContent = 'Uploading...';
      document.getElementById('imageUploadProgress').style.display = 'block';
      document.getElementById('imageProgressBar').style.width = '10%';
      document.getElementById('imageProgressText').textContent = 'Preparing upload...';
      
      try {
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('type', 'image');
        formData.append('artistName', artistName);
        
        if (isNewArtist) {
          formData.append('imageAction', 'new-artist');
          formData.append('artistGenre', genre);
          formData.append('isNewArtist', 'true');
        } else if (isMainThumbnail) {
          formData.append('imageAction', 'replace-thumbnail');
        } else {
          formData.append('imageAction', 'add-to-folder');
        }
        
        document.getElementById('imageProgressBar').style.width = '30%';
        document.getElementById('imageProgressText').textContent = 'Uploading to Arweave...';
        
        const response = await fetch('/api/upload', {
          method: 'POST',
          body: formData
        });
        
        document.getElementById('imageProgressBar').style.width = '80%';
        const result = await response.json();
        
        document.getElementById('imageProgressBar').style.width = '100%';
        document.getElementById('imageUploadProgress').style.display = 'none';
        
        const statusDiv = document.getElementById('imageUploadStatus');
        statusDiv.style.display = 'block';
        
        if (result.success) {
          statusDiv.style.background = 'rgba(16, 185, 129, 0.2)';
          statusDiv.style.border = '1px solid #10b981';
          statusDiv.innerHTML = `
            <div style="color: #10b981; font-weight: bold; margin-bottom: 0.5rem;">Upload Successful!</div>
            <div style="color: white; font-size: 0.875rem;">
              ${isNewArtist ? `Created new artist: <strong>${artistName}</strong><br/>` : ''}
              ${!isNewArtist && isMainThumbnail ? `Updated thumbnail for: <strong>${artistName}</strong><br/>` : ''}
              ${!isNewArtist && !isMainThumbnail ? `Added image to ${artistName}'s folder<br/>` : ''}
              <span style="opacity: 0.8; word-break: break-all;">Arweave URL: ${result.arweaveUrl}</span>
            </div>
            <button onclick="hideArtistImageModal()" class="btn-green-gradient" style="margin-top: 1rem; padding: 0.5rem 1rem; cursor: pointer;">
              Done
            </button>
          `;
        } else {
          statusDiv.style.background = 'rgba(239, 68, 68, 0.2)';
          statusDiv.style.border = '1px solid #ef4444';
          statusDiv.innerHTML = `
            <div style="color: #ef4444; font-weight: bold; margin-bottom: 0.5rem;">Upload Failed</div>
            <div style="color: white; font-size: 0.875rem;">${result.error || 'Unknown error'}</div>
            <button onclick="resetArtistImageModal(); document.getElementById('imageUploadBtn').textContent = 'Upload to Arweave';" style="margin-top: 1rem; padding: 0.5rem 1rem; background: transparent; border: 1px solid var(--color-yellow-75); border-radius: 5px; color: var(--color-yellow-75); cursor: pointer;">
              Try Again
            </button>
          `;
        }
      } catch (error) {
        console.error('Upload error:', error);
        document.getElementById('imageUploadProgress').style.display = 'none';
        const statusDiv = document.getElementById('imageUploadStatus');
        statusDiv.style.display = 'block';
        statusDiv.style.background = 'rgba(239, 68, 68, 0.2)';
        statusDiv.style.border = '1px solid #ef4444';
        statusDiv.innerHTML = `
          <div style="color: #ef4444; font-weight: bold; margin-bottom: 0.5rem;">Upload Failed</div>
          <div style="color: white; font-size: 0.875rem;">${error.message}</div>
          <button onclick="resetArtistImageModal(); document.getElementById('imageUploadBtn').textContent = 'Upload to Arweave';" style="margin-top: 1rem; padding: 0.5rem 1rem; background: transparent; border: 1px solid var(--color-yellow-75); border-radius: 5px; color: var(--color-yellow-75); cursor: pointer;">
            Try Again
          </button>
        `;
      }
      
      uploadBtn.disabled = false;
      uploadBtn.textContent = 'Upload to Arweave';
    };

    // Close artist image modal when clicking outside
    document.getElementById('artistImageModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'artistImageModal') {
        hideArtistImageModal();
      }
    });

    // =====================================================
    // End Artist Image Upload Modal Functions
    // =====================================================

    /**
     * Toggle between file upload and URL input
     */
    function toggleMixUploadType(type) {
      const fileContainer = document.getElementById('mixFileUploadContainer');
      const urlContainer = document.getElementById('mixUrlContainer');
      const fileInput = document.getElementById('mixFileInput');
      const urlInput = document.getElementById('mixUrlInput');
      
      if (type === 'file') {
        fileContainer.style.display = 'block';
        urlContainer.style.display = 'none';
        fileInput.required = true;
        urlInput.required = false;
        urlInput.value = '';
      } else {
        fileContainer.style.display = 'none';
        urlContainer.style.display = 'block';
        fileInput.required = false;
        urlInput.required = true;
        fileInput.value = '';
      }
    }

    /**
     * Handle mix upload
     */
    async function handleMixUpload(event) {
      event.preventDefault();
      
      const artistSelect = document.getElementById('mixArtistSelect');
      const artistNameInput = document.getElementById('mixArtistName');
      const artistImageInput = document.getElementById('mixArtistImageInput');
      
      // Get artist name - from select or input
      let artistName = '';
      let isNewArtist = false;
      
      if (artistSelect.value === '__new__') {
        // New artist
        artistName = artistNameInput.value.trim();
        isNewArtist = true;
        
        if (!artistName) {
          showToast('Please enter a new artist name', 'error');
          return;
        }
        
        // Check if artist image is required for new artists
        if (!artistImageInput.files || artistImageInput.files.length === 0) {
          showToast('Artist image is required for new artists', 'error');
          return;
        }
      } else if (artistSelect.value) {
        // Existing artist
        artistName = artistSelect.value;
      } else {
        showToast('Please select an artist or create a new one', 'error');
        return;
      }
      
      const uploadType = document.querySelector('input[name="uploadType"]:checked').value;
      const mixFile = document.getElementById('mixFileInput').files[0];
      const mixUrl = document.getElementById('mixUrlInput').value.trim();
      const mixTitle = document.getElementById('mixTitleInput').value.trim();
      const mixDate = document.getElementById('mixDateInput').value.trim();
      const mixDuration = document.getElementById('mixDurationInput').value.trim();
      const isTrack = document.getElementById('mixIsTrack').checked;
      
      if (!artistName) {
        showToast('Please select an artist or create a new one', 'error');
        return;
      }
      
      if (uploadType === 'file' && !mixFile) {
        showToast('Please select an audio file', 'error');
        return;
      }
      
      if (uploadType === 'url' && !mixUrl) {
        showToast('Please enter an Arweave URL', 'error');
        return;
      }
      
      // Show progress
      const progressDiv = document.getElementById('mixUploadProgress');
      const progressBar = document.getElementById('mixUploadProgressBar');
      const progressPercent = document.getElementById('mixUploadPercent');
      const progressStatus = document.getElementById('mixUploadStatus');
      const statusMsg = document.getElementById('mixUploadStatusMsg');
      const submitBtn = document.getElementById('mixUploadSubmitBtn');
      
      progressDiv.style.display = 'block';
      statusMsg.style.display = 'none';
      submitBtn.disabled = true;
      
      try {
        progressStatus.textContent = 'Preparing upload...';
        progressBar.style.width = '10%';
        progressPercent.textContent = '10%';
        
        let firebasePath = null;
        
        if (uploadType === 'file') {
          // Upload to Firebase Storage first (like archive upload does)
          progressStatus.textContent = 'Uploading to Firebase...';
          progressBar.style.width = '20%';
          progressPercent.textContent = '20%';
          
          const { storage, ref, uploadBytesResumable, getDownloadURL } = window.firebase;
          const fileName = `mix_${Date.now()}_${mixFile.name}`;
          const storagePath = `mixes/${artistName}/${fileName}`;
          const storageRef = ref(storage, storagePath);
          
          // Upload to Firebase
          const uploadTask = uploadBytesResumable(storageRef, mixFile, {
            contentType: 'audio/mpeg',
            customMetadata: {
              originalName: mixFile.name,
              artist: artistName,
              title: mixTitle || mixFile.name,
              uploadedAt: new Date().toISOString()
            }
          });
          
          // Wait for Firebase upload to complete
          await new Promise((resolve, reject) => {
            uploadTask.on(
              'state_changed',
              (snapshot) => {
                const uploadProgress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                progressBar.style.width = `${10 + (uploadProgress * 0.2)}%`;
                progressPercent.textContent = `${Math.round(10 + (uploadProgress * 0.2))}%`;
              },
              (error) => {
                console.error('Firebase upload error:', error);
                reject(error);
              },
              async () => {
                firebasePath = storagePath;
                console.log('[Mix Upload] File uploaded to Firebase:', firebasePath);
                resolve();
              }
            );
          });
        }
        
        progressStatus.textContent = 'Uploading to Arweave...';
        progressBar.style.width = '30%';
        progressPercent.textContent = '30%';
        
        // Handle new artist image upload if it's a new artist
        let artistImagePath = null;
        if (isNewArtist && artistImageInput.files && artistImageInput.files.length > 0) {
          const artistImageFile = artistImageInput.files[0];
          progressStatus.textContent = 'Uploading artist image to Firebase...';
          progressBar.style.width = '25%';
          progressPercent.textContent = '25%';
          
          const { storage, ref, uploadBytesResumable } = window.firebase;
          const imageFileName = `artist_${Date.now()}_${artistImageFile.name}`;
          const imageStoragePath = `artist-images/${artistName}/${imageFileName}`;
          const imageStorageRef = ref(storage, imageStoragePath);
          
          await new Promise((resolve, reject) => {
            const imageUploadTask = uploadBytesResumable(imageStorageRef, artistImageFile, {
              contentType: artistImageFile.type || 'image/jpeg',
              customMetadata: {
                artist: artistName,
                uploadedAt: new Date().toISOString()
              }
            });
            
            imageUploadTask.on(
              'state_changed',
              (snapshot) => {
                const imageProgress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                progressBar.style.width = `${25 + (imageProgress * 0.05)}%`;
                progressPercent.textContent = `${Math.round(25 + (imageProgress * 0.05))}%`;
              },
              (error) => {
                console.error('Artist image Firebase upload error:', error);
                reject(error);
              },
              () => {
                artistImagePath = imageStoragePath;
                console.log('[Mix Upload] Artist image uploaded to Firebase:', artistImagePath);
                resolve();
              }
            );
          });
        }
        
        progressStatus.textContent = 'Uploading to Arweave...';
        progressBar.style.width = '30%';
        progressPercent.textContent = '30%';
        
        // Send JSON to API (like archive upload does) - no file in request body!
        const requestBody = {
          type: 'audio',
          artistName: artistName,
          mixTitle: mixTitle,
          mixDateYear: mixDate,
          mixDuration: mixDuration,
          isTrack: isTrack.toString()
        };
        
        if (uploadType === 'file' && firebasePath) {
          // Send Firebase path instead of file
          requestBody.firebasePath = firebasePath;
        } else if (uploadType === 'url') {
          requestBody.mixUrl = mixUrl;
        }
        
        if (artistImagePath) {
          requestBody.artistImagePath = artistImagePath;
        }
        
        // Upload to API (JSON, not FormData - matches archive upload!)
        console.log('[Mix Upload] Sending request to /api/upload:', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: requestBody
        });
        
        const response = await fetch('/api/upload', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(requestBody)
        });
        
        console.log('[Mix Upload] Response received:', {
          status: response.status,
          statusText: response.statusText,
          ok: response.ok,
          headers: Object.fromEntries(response.headers.entries())
        });
        
        progressBar.style.width = '70%';
        progressPercent.textContent = '70%';
        progressStatus.textContent = 'Processing...';
        
        // Check if response is OK
        if (!response.ok) {
          console.error('[Mix Upload] Response not OK:', response.status, response.statusText);
          const text = await response.text();
          console.error('Upload failed with status:', response.status);
          console.error('Response text:', text.substring(0, 500));
          
          // Try to parse as JSON, but handle HTML error pages
          let errorMessage = `Upload failed with status ${response.status}`;
          try {
            const errorData = JSON.parse(text);
            errorMessage = errorData.error || errorData.message || errorMessage;
          } catch (e) {
            // Response is not JSON (likely HTML error page)
            if (text.includes('Forbidden')) {
              errorMessage = 'Upload forbidden: Check your Arweave wallet credentials in Vercel environment variables. The ARWEAVE_WALLET_JWK may be invalid or have insufficient permissions.';
            } else if (text.includes('Unauthorized')) {
              errorMessage = 'Upload unauthorized: Check your Arweave wallet credentials.';
            } else {
              errorMessage = `Server error: ${text.substring(0, 200)}`;
            }
          }
          throw new Error(errorMessage);
        }
        
        let data;
        try {
          data = await response.json();
        } catch (jsonError) {
          const text = await response.text();
          console.error('Failed to parse JSON response:', text);
          throw new Error(`Server returned invalid JSON: ${text.substring(0, 200)}`);
        }
        
        if (!data.success) {
          throw new Error(data.error || data.message || 'Upload failed');
        }
        
        progressBar.style.width = '100%';
        progressPercent.textContent = '100%';
        progressStatus.textContent = 'Complete!';
        
        // Show success message with cost
        let costInfo = '';
        if (data.cost) {
          costInfo = `<div style="margin-top: 0.5rem; font-size: 0.75rem; opacity: 0.9;">
            Upload cost: ${data.cost.costAR.toFixed(6)} AR (~$${data.cost.costUSD.toFixed(4)} USD)
          </div>`;
        }
        
        statusMsg.style.display = 'block';
        
        // Build Arweave URL display
        let arweaveUrlDisplay = '';
        if (data.arweaveUrl) {
          arweaveUrlDisplay = `
            <div style="margin-top: 0.5rem; font-size: 0.875rem;">
              <strong>Arweave URL:</strong><br/>
              <a href="${data.arweaveUrl}" target="_blank" rel="noopener noreferrer" style="color: #10b981; text-decoration: underline; word-break: break-all;">
                ${data.arweaveUrl}
              </a>
            </div>
          `;
        }
        
        statusMsg.innerHTML = `
          <div style="background: #0a5d0a; border: 2px solid #10b981; border-radius: 5px; padding: 1rem; color: #10b981;">
            <strong>Upload successful!</strong><br/>
            <div style="margin-top: 0.5rem; font-size: 0.875rem;">
              ${uploadType === 'file' ? `File: ${data.fileName || 'N/A'}` : `Using Arweave URL: ${mixUrl}`}<br/>
              ${arweaveUrlDisplay}
              ${costInfo}
            </div>
            <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #10b981;">
              <div style="font-size: 0.875rem; margin-bottom: 0.75rem;">Deploy ${artistName} to website?</div>
              <div style="display: flex; gap: 0.5rem;">
                <button 
                  onclick="deployArtistToWebsite('${artistName}')"
                  class="btn-green-gradient"
                  style="flex: 1; padding: 0.5rem; cursor: pointer; font-size: 0.875rem;"
                >
                  Yes, Deploy
                </button>
                <button 
                  onclick="document.getElementById('mixUploadStatusMsg').innerHTML = '';"
                  style="flex: 1; padding: 0.5rem; background: transparent; color: var(--color-yellow-75); border: 2px solid var(--color-yellow-75); border-radius: 5px; font-family: var(--font-mathias); font-weight: bold; cursor: pointer; font-size: 0.875rem;"
                >
                  Skip
                </button>
              </div>
            </div>
          </div>
        `;
        
        showToast(`Mix uploaded successfully for ${artistName}!`, 'success');
        
        // Reload artists list
        loadArtists();
        
        // Refresh usage indicators after successful upload
        loadStorageUsage();
        loadFirestoreUsage();
        
        // Don't auto-close modal - let user decide on deployment
        
      } catch (error) {
        console.error('Error uploading mix:', error);
        progressStatus.textContent = 'Failed';
        progressBar.style.background = '#ef4444';
        
        statusMsg.style.display = 'block';
        statusMsg.innerHTML = `
          <div style="background: #5d0a0a; border: 2px solid #ef4444; border-radius: 5px; padding: 1rem; color: #ef4444;">
            <strong>Upload failed</strong><br/>
            <div style="margin-top: 0.5rem; font-size: 0.875rem;">${error.message}</div>
          </div>
        `;
        
        showToast(`Upload failed: ${error.message}`, 'error');
      } finally {
        submitBtn.disabled = false;
      }
    }

    /**
     * Update selected files list
     */
    function updateSelectedFilesList() {
      const fileInput = document.getElementById('videoFileInput');
      const selectedFilesList = document.getElementById('selectedFilesList');
      const selectedFilesContainer = document.getElementById('selectedFilesContainer');
      
      if (fileInput.files.length === 0) {
        selectedFilesList.style.display = 'none';
        return;
      }
      
      selectedFilesList.style.display = 'block';
      selectedFilesContainer.innerHTML = '';
      
      Array.from(fileInput.files).forEach((file, index) => {
        const fileItem = document.createElement('div');
        fileItem.style.cssText = 'padding: 0.5rem; background: #1a1a1a; border-radius: 3px; margin-bottom: 0.25rem;';
        fileItem.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <span style="color: var(--color-yellow-75); font-family: var(--font-mathias); font-size: 0.75rem;">
              ${index + 1}. ${file.name} (${(file.size / (1024 * 1024)).toFixed(2)} MB)
            </span>
          </div>
        `;
        selectedFilesContainer.appendChild(fileItem);
      });
    }

    // Add event listener for file selection
    document.addEventListener('DOMContentLoaded', () => {
      const fileInput = document.getElementById('videoFileInput');
      if (fileInput) {
        fileInput.addEventListener('change', updateSelectedFilesList);
      }
    });

    /**
     * Hide upload modal
     */
    window.hideUploadModal = function() {
      document.getElementById('uploadModal').style.display = 'none';
    };

    /**
     * Handle video upload (supports multiple files)
     */
    async function handleVideoUpload(event) {
      event.preventDefault();
      
      const fileInput = document.getElementById('videoFileInput');
      const orientation = document.getElementById('orientationSelect').value;
      const folderTypeExisting = document.getElementById('folderTypeExisting');
      const folderTypeNew = document.getElementById('folderTypeNew');
      const files = Array.from(fileInput.files);
      
      if (files.length === 0) {
        showToast('Please select at least one video file', 'error');
        return;
      }
      
      // Determine folder name
      let folder;
      let isNewFolder = false;
      
      if (folderTypeNew.checked) {
        const newFolderName = document.getElementById('newFolderName').value.trim();
        if (!newFolderName) {
          showToast('Please enter a folder name', 'error');
          return;
        }
        // Sanitize folder name: lowercase, replace spaces with hyphens, remove invalid chars
        folder = newFolderName.toLowerCase()
          .replace(/\s+/g, '-')
          .replace(/[^a-z0-9-_]/g, '')
          .replace(/^-+|-+$/g, '');
        
        if (!folder) {
          showToast('Please enter a valid folder name', 'error');
          return;
        }
        isNewFolder = true;
      } else {
        folder = document.getElementById('folderSelect').value;
        if (!folder) {
          showToast('Please select a folder', 'error');
          return;
        }
      }

      // Validate files based on folder type
      // Determine if this is an image folder or video folder
      const isImageFolder = folder === 'logos' || folder === 'paper_backgrounds';
      const allowedTypes = isImageFolder 
        ? ['.png', '.jpg', '.jpeg', '.gif', '.svg', '.webp'] 
        : ['.mov', '.mp4', '.m4v', '.avi', '.mkv', '.webm'];
      const maxSize = isImageFolder ? 50 * 1024 * 1024 : 500 * 1024 * 1024; // 50MB for images, 500MB for videos
      const invalidFiles = [];
      
      files.forEach((file, index) => {
        const fileExt = '.' + file.name.split('.').pop().toLowerCase();
        if (!allowedTypes.includes(fileExt)) {
          invalidFiles.push(`${file.name} (invalid type - ${isImageFolder ? 'images only' : 'videos only'})`);
        }
        if (file.size > maxSize) {
          invalidFiles.push(`${file.name} (exceeds ${isImageFolder ? '50MB' : '500MB'})`);
        }
      });

      if (invalidFiles.length > 0) {
        showToast(`Invalid files: ${invalidFiles.join(', ')}`, 'error');
        return;
      }

      // Show progress
      const uploadProgress = document.getElementById('uploadProgress');
      const uploadFilesList = document.getElementById('uploadFilesList');
      const uploadStatus = document.getElementById('uploadStatus');
      const uploadSubmitBtn = document.getElementById('uploadSubmitBtn');
      
      uploadProgress.style.display = 'block';
      uploadStatus.style.display = 'none';
      uploadSubmitBtn.disabled = true;
      uploadFilesList.innerHTML = '';
      
      // Create progress elements for each file
      const fileProgressMap = new Map();
      files.forEach((file, index) => {
        const fileProgressDiv = document.createElement('div');
        fileProgressDiv.id = `file-progress-${index}`;
        fileProgressDiv.style.cssText = 'background: #1a1a1a; border: 1px solid var(--color-yellow-75); border-radius: 5px; padding: 0.75rem;';
        fileProgressDiv.innerHTML = `
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <span style="color: var(--color-yellow-75); font-family: var(--font-mathias); font-size: 0.75rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 60%;">
              ${file.name}
            </span>
            <span id="file-percent-${index}" style="color: var(--color-yellow-75); font-family: var(--font-mathias); font-size: 0.75rem;">0%</span>
          </div>
          <div style="background: #0a0a0a; border: 1px solid var(--color-yellow-75); border-radius: 3px; height: 12px; overflow: hidden;">
            <div id="file-progress-bar-${index}" style="background: var(--color-yellow-75); height: 100%; width: 0%; transition: width 0.3s;"></div>
          </div>
          <div id="file-status-${index}" style="color: #888; font-family: var(--font-mathias); font-size: 0.7rem; margin-top: 0.25rem;">Waiting...</div>
        `;
        uploadFilesList.appendChild(fileProgressDiv);
        fileProgressMap.set(index, {
          file,
          div: fileProgressDiv,
          percent: document.getElementById(`file-percent-${index}`),
          progressBar: document.getElementById(`file-progress-bar-${index}`),
          status: document.getElementById(`file-status-${index}`)
        });
      });

      // Upload files sequentially to avoid overwhelming the browser
      const uploadResults = [];
      let successCount = 0;
      let failCount = 0;
      
      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        const progress = fileProgressMap.get(i);
        
        try {
          progress.status.textContent = 'Uploading...';
          progress.status.style.color = '#888';
          
          // Upload directly to Firebase Storage
          const { storage, ref, uploadBytesResumable, getDownloadURL } = window.firebase;
          const fileName = `user_upload_${Date.now()}_${i}_${file.name}`;
          
          // Handle special case for chicago-skyline-videos (needs assets/ prefix)
          let storagePath;
          if (folder === 'chicago-skyline-videos') {
            storagePath = `assets/chicago-skyline-videos/${fileName}`;
          } else {
            storagePath = `${folder}/${fileName}`;
          }
          
          const storageRef = ref(storage, storagePath);
          
          // Create upload task
          const uploadTask = uploadBytesResumable(storageRef, file, {
            contentType: file.type || 'video/mp4',
            customMetadata: {
              originalName: file.name,
              orientation: orientation,
              uploadedAt: new Date().toISOString()
            }
          });

          // Wait for upload to complete
          await new Promise((resolve, reject) => {
            uploadTask.on('state_changed',
              (snapshot) => {
                const progressPercent = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                progress.percent.textContent = Math.round(progressPercent) + '%';
                progress.progressBar.style.width = progressPercent + '%';
              },
              (error) => {
                console.error(`Upload error for ${file.name}:`, error);
                progress.status.textContent = `Failed: ${error.message}`;
                progress.status.style.color = '#ef4444';
                progress.progressBar.style.background = '#ef4444';
                reject(error);
              },
              async () => {
                try {
                  // Get download URL
                  const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                  progress.status.textContent = 'Uploaded';
                  progress.status.style.color = '#10b981';
                  progress.progressBar.style.background = '#10b981';
                  uploadResults.push({ file: file.name, success: true, url: downloadURL });
                  successCount++;
                  resolve();
                } catch (error) {
                  console.error(`Error getting download URL for ${file.name}:`, error);
                  progress.status.textContent = 'Uploaded (URL issue)';
                  progress.status.style.color = '#fbbf24';
                  uploadResults.push({ file: file.name, success: false, error: error.message });
                  failCount++;
                  resolve(); // Continue even if URL fetch fails
                }
              }
            );
          });
        } catch (error) {
          console.error(`Upload error for ${file.name}:`, error);
          progress.status.textContent = `Failed: ${error.message}`;
          progress.status.style.color = '#ef4444';
          progress.progressBar.style.background = '#ef4444';
          uploadResults.push({ file: file.name, success: false, error: error.message });
          failCount++;
        }
        
        // Update summary
        document.getElementById('uploadSummary').textContent = `${successCount + failCount} / ${files.length}`;
      }

      // If new folder was created and uploads succeeded, refresh folder list
      if (isNewFolder && successCount > 0) {
        // Add new folder to availableFolders array
        const newFolderEntry = {
          name: folder,
          count: successCount,
          displayName: folder.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase()),
          type: 'video'
        };
        
        // Check if folder already exists in the list
        const existingIndex = availableFolders.findIndex(f => f.name === folder);
        if (existingIndex >= 0) {
          availableFolders[existingIndex] = newFolderEntry;
        } else {
          availableFolders.push(newFolderEntry);
        }
        
        // Refresh folder select dropdown
        populateUploadFolderSelect();
        
        // Also refresh the folder selection for video generation
        await loadAvailableFolders();
        
        console.log(`‚úÖ New folder "${folder}" created and added to folder list`);
      }
      
      // Show final status
      uploadStatus.style.display = 'block';
      if (successCount === files.length) {
        const folderMessage = isNewFolder 
          ? `All ${successCount} file(s) uploaded successfully to new folder "${folder}"!`
          : `All ${successCount} file(s) uploaded successfully!`;
        
        uploadStatus.innerHTML = `
          <div style="background: #0a5d0a; border: 2px solid #10b981; border-radius: 5px; padding: 1rem; color: #10b981;">
            <strong>${folderMessage}</strong>
            ${isNewFolder ? `<div style="margin-top: 0.5rem; font-size: 0.875rem;">The folder "${folder}" is now available for video generation.</div>` : ''}
          </div>
        `;
        showToast(`Successfully uploaded ${successCount} file(s)!`, 'success');
        // Refresh usage indicators after successful upload
        loadStorageUsage();
        loadFirestoreUsage();
      } else if (successCount > 0) {
        uploadStatus.innerHTML = `
          <div style="background: #5d4a0a; border: 2px solid #fbbf24; border-radius: 5px; padding: 1rem; color: #fbbf24;">
            <strong>Partial success: ${successCount} succeeded, ${failCount} failed</strong>
          </div>
        `;
        showToast(`Uploaded ${successCount} file(s), ${failCount} failed`, 'error');
      } else {
        uploadStatus.innerHTML = `
          <div style="background: #5d0a0a; border: 2px solid #ef4444; border-radius: 5px; padding: 1rem; color: #ef4444;">
            <strong>All uploads failed</strong>
          </div>
        `;
        showToast('All uploads failed', 'error');
      }
      
      uploadSubmitBtn.disabled = false;
      
      // Reset form after 5 seconds if all succeeded
      if (successCount === files.length) {
        setTimeout(() => {
          hideUploadModal();
        }, 5000);
      }
    }

    /**
     * Estimate deployment cost before deploying
     */
    async function estimateDeployCost() {
      try {
        const response = await fetch('/api/deploy-website?estimate=true', {
          method: 'GET'
        });
        
        const data = await response.json();
        return data;
      } catch (error) {
        console.error('Error estimating deploy cost:', error);
        return null;
      }
    }

    /**
     * Deploy website to Arweave
     */
    /**
     * Deploy specific artist to website
     */
    async function deployArtistToWebsite(artistName) {
      const statusMsg = document.getElementById('mixUploadStatusMsg');
      const originalContent = statusMsg.innerHTML;
      
      try {
        statusMsg.innerHTML = `
          <div style="background: #1a1a1a; border: 2px solid var(--color-yellow-75); border-radius: 5px; padding: 1rem; color: var(--color-yellow-75);">
            <div style="display: flex; align-items: center; gap: 0.5rem;">
              <div class="inline-block w-4 h-4 border-2 border-t-transparent rounded-full animate-spin" style="border-color: var(--color-yellow-75); border-top-color: transparent;"></div>
              <span>Deploying website...</span>
            </div>
          </div>
        `;
        
        showToast('Starting website deployment...', 'info');
        
        const response = await fetch('/api/deploy-website', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({})
        });
        
        let data;
        try {
          data = await response.json();
        } catch (jsonError) {
          const text = await response.text();
          throw new Error(`Server returned invalid JSON: ${text.substring(0, 100)}`);
        }
        
        if (!data.success) {
          throw new Error(data.error || data.message || 'Deployment failed');
        }
        
        const websiteUrl = data.websiteUrl || `https://arweave.net/${data.manifestId}/index.html`;
        
        statusMsg.innerHTML = `
          <div style="background: #0a5d0a; border: 2px solid #10b981; border-radius: 5px; padding: 1rem; color: #10b981;">
            <strong>Website deployed!</strong><br/>
            <div style="margin-top: 0.5rem; font-size: 0.875rem;">
              <a href="${websiteUrl}" target="_blank" rel="noopener noreferrer" style="color: #10b981; text-decoration: underline; word-break: break-all;">
                ${websiteUrl}
              </a>
            </div>
          </div>
        `;
        
        showToast('Website deployed successfully!', 'success');
        
      } catch (error) {
        console.error('Error deploying website:', error);
        statusMsg.innerHTML = `
          <div style="background: #5d0a0a; border: 2px solid #ef4444; border-radius: 5px; padding: 1rem; color: #ef4444;">
            <strong>Deployment failed</strong><br/>
            <div style="margin-top: 0.5rem; font-size: 0.875rem;">
              ${error.message}
            </div>
          </div>
        `;
        showToast(`Deployment failed: ${error.message}`, 'error');
      }
    }

    // Deploy modal functions
    window.showDeployModal = function(title, content) {
      document.getElementById('deployModalTitle').innerHTML = title;
      document.getElementById('deployModalContent').innerHTML = content;
      document.getElementById('deployModal').style.display = 'flex';
    };
    
    window.hideDeployModal = function() {
      document.getElementById('deployModal').style.display = 'none';
    };
    
    // Close deploy modal when clicking outside
    document.getElementById('deployModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'deployModal') {
        hideDeployModal();
      }
    });

    window.deployWebsite = async function() {
      const deployBtn = document.getElementById('deployWebsiteBtn');
      const originalText = deployBtn.innerHTML;
      
      // Estimate cost first
      deployBtn.disabled = true;
      deployBtn.innerHTML = 'üí∞ Estimating cost...';
      
      let estimateData = null;
      try {
        estimateData = await estimateDeployCost();
      } catch (error) {
        console.warn('Could not estimate cost:', error);
      }
      
      // Build cost estimate display
      let costHtml = '';
      if (estimateData && estimateData.success && estimateData.cost && estimateData.cost.costAR > 0) {
        const cost = estimateData.cost;
        costHtml = `
          <div style="background: #1a1a1a; border: 2px solid var(--color-yellow-75); border-radius: 5px; padding: 1rem; margin-bottom: 1rem;">
            <div style="font-size: 0.875rem; margin-bottom: 0.5rem;">üí∞ <strong>Estimated Cost:</strong></div>
            <div style="font-size: 1.25rem; font-family: var(--font-mathias);">${cost.costAR.toFixed(6)} AR (~$${cost.costUSD.toFixed(4)} USD)</div>
            ${estimateData.filesChanged !== undefined ? `
              <div style="font-size: 0.75rem; margin-top: 0.5rem; color: #888;">
                ${estimateData.filesChanged} files to upload (${estimateData.filesUnchanged || 0} unchanged will be reused)
              </div>
            ` : ''}
          </div>
        `;
      }
      
      // Show confirmation modal
      const confirmContent = `
        <div style="margin-bottom: 1rem;">
          This will deploy the website to Arweave. This may take several minutes.
        </div>
        ${costHtml}
        <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
          <button 
            id="confirmDeployBtn"
            class="btn-green-gradient"
            style="flex: 1; padding: 0.75rem; cursor: pointer; font-size: 1rem;"
          >
            Yes, Deploy
          </button>
          <button 
            onclick="hideDeployModal(); document.getElementById('deployWebsiteBtn').disabled = false; document.getElementById('deployWebsiteBtn').innerHTML = 'Deploy Website';"
            style="flex: 1; padding: 0.75rem; background: transparent; color: var(--color-yellow-75); border: 2px solid var(--color-yellow-75); border-radius: 5px; font-family: var(--font-mathias); font-weight: bold; cursor: pointer; font-size: 1rem;"
          >
            Cancel
          </button>
        </div>
      `;
      
      showDeployModal('Deploy Website to Arweave', confirmContent);
      
      // Add click handler for confirm button
      document.getElementById('confirmDeployBtn').onclick = async function() {
        hideDeployModal();
        deployBtn.innerHTML = 'Deploying...';
        
        try {
          showToast('Starting website deployment to Arweave...', 'info');
          
          const response = await fetch('/api/deploy-website', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
          });
          
          let data;
          try {
            data = await response.json();
          } catch (jsonError) {
            const text = await response.text();
            console.error('Failed to parse JSON response:', text);
            throw new Error(`Server returned invalid JSON: ${text.substring(0, 100)}`);
          }
          
          if (!data.success) {
            throw new Error(data.error || data.message || 'Deployment failed');
          }
          
          // Show success with manifest URL
          const manifestUrl = data.manifestUrl || `https://arweave.net/${data.manifestId}`;
          const websiteUrl = data.websiteUrl || `https://arweave.net/${data.manifestId}/index.html`;
          const arnsUrl = data.arnsUrl || null;
          
          // Store the latest website URL for "View Site" button
          localStorage.setItem('latestArweaveWebsiteUrl', websiteUrl);
          if (arnsUrl) {
            localStorage.setItem('latestArNSUrl', arnsUrl);
          }
          
          showToast('Website deployed successfully!', 'success');
          
          // Build cost info
          let costInfoHtml = '';
          if (data.costEstimate && data.costEstimate.costAR > 0) {
            costInfoHtml = `
              <div style="margin-top: 0.75rem; font-size: 0.875rem;">
                üí∞ <strong>Cost:</strong> ${data.costEstimate.costAR.toFixed(6)} AR (~$${data.costEstimate.costUSD.toFixed(4)} USD)
              </div>
            `;
          }
          
          // Build ArNS URL display
          let arnsHtml = '';
          if (arnsUrl) {
            arnsHtml = `
              <div style="margin-top: 1rem; font-size: 0.875rem;">
                <div style="margin-bottom: 0.5rem;">üåê <strong>ArNS Domain:</strong></div>
                <a href="${arnsUrl}" target="_blank" rel="noopener noreferrer" style="color: #10b981; text-decoration: underline; word-break: break-all; display: block; background: rgba(0,0,0,0.3); padding: 0.5rem; border-radius: 3px; font-weight: bold;">
                  ${arnsUrl}
                </a>
                <div style="margin-top: 0.25rem; font-size: 0.7rem; color: #888;">
                  ‚è±Ô∏è ArNS updates may take a few minutes to propagate
                </div>
              </div>
            `;
          } else {
            arnsHtml = `
              <div style="margin-top: 1rem; font-size: 0.875rem; color: #fbbf24;">
                ‚ö†Ô∏è ArNS update was not successful. Check logs for details.
              </div>
            `;
          }
          
          // Show styled success modal
          const successContent = `
            <div style="background: #0a5d0a; border: 2px solid #10b981; border-radius: 5px; padding: 1.25rem; color: #10b981;">
              <strong style="font-size: 1.1rem;">Website Deployed Successfully!</strong>
              
              <div style="margin-top: 1rem; font-size: 0.875rem;">
                <div style="margin-bottom: 0.5rem;">üìã <strong>Manifest ID:</strong></div>
                <div style="word-break: break-all; background: rgba(0,0,0,0.3); padding: 0.5rem; border-radius: 3px; font-family: monospace; font-size: 0.75rem;">${data.manifestId}</div>
              </div>
              
              <div style="margin-top: 1rem; font-size: 0.875rem;">
                <div style="margin-bottom: 0.5rem;"><strong>Direct Arweave URL:</strong></div>
                <a href="${websiteUrl}" target="_blank" rel="noopener noreferrer" style="color: #10b981; text-decoration: underline; word-break: break-all; display: block; background: rgba(0,0,0,0.3); padding: 0.5rem; border-radius: 3px;">
                  ${websiteUrl}
                </a>
              </div>
              
              ${arnsHtml}
              
              <div style="margin-top: 0.75rem; font-size: 0.875rem;">
                <strong>Files:</strong> ${data.filesUploaded} uploaded, ${data.filesUnchanged || 0} unchanged
              </div>
              
              ${costInfoHtml}
            </div>
            
            <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem; flex-wrap: wrap;">
              ${arnsUrl ? `
                <button 
                  onclick="window.open('${arnsUrl}', '_blank'); hideDeployModal();"
                  class="btn-green-gradient"
                  style="flex: 1; min-width: 120px; padding: 0.75rem; cursor: pointer; font-size: 1rem;"
                >
                  View ArNS Site
                </button>
              ` : ''}
              <button 
                onclick="window.open('${websiteUrl}', '_blank'); hideDeployModal();"
                class="btn-green-gradient"
                style="flex: 1; min-width: 120px; padding: 0.75rem; cursor: pointer; font-size: 1rem;"
              >
                View Arweave Site
              </button>
              <button 
                onclick="hideDeployModal();"
                style="flex: 1; min-width: 120px; padding: 0.75rem; background: transparent; color: var(--color-yellow-75); border: 2px solid var(--color-yellow-75); border-radius: 5px; font-family: var(--font-mathias); font-weight: bold; cursor: pointer; font-size: 1rem;"
              >
                Close
              </button>
            </div>
          `;
          
          showDeployModal('üéâ Deployment Complete', successContent);
          
          // Copy website URL to clipboard if possible
          if (navigator.clipboard) {
            navigator.clipboard.writeText(websiteUrl).then(() => {
              console.log('Website URL copied to clipboard');
            });
          }
          
        } catch (error) {
          console.error('Error deploying website:', error);
          showToast(`Deployment failed: ${error.message}`, 'error');
          
          // Show styled error modal
          const errorContent = `
            <div style="background: #5d0a0a; border: 2px solid #ef4444; border-radius: 5px; padding: 1.25rem; color: #ef4444;">
              <strong style="font-size: 1.1rem;">Deployment Failed</strong>
              <div style="margin-top: 1rem; font-size: 0.875rem;">
                ${error.message}
              </div>
            </div>
            <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
              <button 
                onclick="hideDeployModal();"
                style="flex: 1; padding: 0.75rem; background: transparent; color: var(--color-yellow-75); border: 2px solid var(--color-yellow-75); border-radius: 5px; font-family: var(--font-mathias); font-weight: bold; cursor: pointer; font-size: 1rem;"
              >
                Close
              </button>
            </div>
          `;
          
          showDeployModal('Deployment Error', errorContent);
        } finally {
          deployBtn.disabled = false;
          deployBtn.innerHTML = originalText;
        }
      };
    }

    // Close modals when clicking outside
    document.getElementById('uploadModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'uploadModal') {
        hideUploadModal();
      }
    });
    
    document.getElementById('uploadMixModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'uploadMixModal') {
        hideUploadMixModal();
      }
    });

    let currentFolder = null;

    /**
     * Load folders with video counts
     */
    window.loadFolders = async function() {
      const foldersGrid = document.getElementById('foldersGrid');
      const foldersLoading = document.getElementById('foldersLoading');
      
      foldersGrid.innerHTML = '';
      foldersLoading.style.display = 'block';
      
      try {
        const response = await fetch('/api/video-folders');
        const data = await response.json();
        
        if (data.success && data.folders) {
          foldersLoading.style.display = 'none';
          
          data.folders.forEach(folder => {
            const folderCard = document.createElement('div');
            folderCard.className = 'folder-card-item';
            folderCard.onclick = () => openFolder(folder.name);
            
            folderCard.innerHTML = `
              <div class="folder-name" style="color: var(--color-yellow-75); font-family: var(--font-mathias); font-weight: bold; font-size: 1rem; margin-bottom: 0.5rem;">
                ${folder.displayName}
              </div>
              <div class="folder-count" style="color: #888; font-family: var(--font-mathias); font-size: 0.875rem;">
                ${folder.count} video${folder.count !== 1 ? 's' : ''}
              </div>
            `;
            
            foldersGrid.appendChild(folderCard);
          });
        } else {
          throw new Error(data.error || 'Failed to load folders');
        }
      } catch (error) {
        console.error('Error loading folders:', error);
        foldersLoading.innerHTML = `<div style="color: #ef4444;">Error loading folders: ${error.message}</div>`;
      }
    }

    /**
     * Open a folder to view its videos
     */
    window.openFolder = async function(folderName) {
      currentFolder = folderName;
      
      const folderListView = document.getElementById('folderListView');
      const folderDetailView = document.getElementById('folderDetailView');
      const folderDetailTitle = document.getElementById('folderDetailTitle');
      const videosGrid = document.getElementById('videosGrid');
      const videosLoading = document.getElementById('videosLoading');
      const videosEmpty = document.getElementById('videosEmpty');
      
      folderListView.style.display = 'none';
      folderDetailView.style.display = 'block';
      
      // Update title
      const displayName = folderName.replace('assets/', '').replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
      folderDetailTitle.textContent = displayName;
      
      videosGrid.innerHTML = '';
      videosLoading.style.display = 'block';
      videosEmpty.style.display = 'none';
      
      try {
        const response = await fetch(`/api/video-folders?folder=${encodeURIComponent(folderName)}`);
        const data = await response.json();
        
        if (data.success && data.videos) {
          videosLoading.style.display = 'none';
          
          if (data.videos.length === 0) {
            videosEmpty.style.display = 'block';
          } else {
            data.videos.forEach(video => {
              const videoCard = document.createElement('div');
              videoCard.style.cssText = `
                background: #1a1a1a;
                border: 2px solid var(--color-yellow-75);
                border-radius: 10px;
                overflow: hidden;
                transition: all 0.3s ease;
                width: 100%;
              `;
              videoCard.onmouseover = () => {
                videoCard.style.transform = 'scale(1.02)';
                videoCard.style.borderColor = '#fff';
              };
              videoCard.onmouseout = () => {
                videoCard.style.transform = 'scale(1)';
                videoCard.style.borderColor = 'var(--color-yellow-75)';
              };
              
              const fileSizeMB = (video.size / (1024 * 1024)).toFixed(2);
              const updatedDate = video.updated ? new Date(video.updated).toLocaleDateString() : 'Unknown';
              
              // Escape quotes in URLs and names for onclick handlers
              const escapedUrl = video.publicUrl.replace(/'/g, "\\'");
              const escapedName = video.name.replace(/'/g, "\\'");
              const escapedFullPath = video.fullPath.replace(/'/g, "\\'");
              
              videoCard.innerHTML = `
                <div style="position: relative; width: 100%; padding-top: 56.25%; background: #0a0a0a;">
                  <video 
                    src="${video.publicUrl}" 
                    style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover;"
                    controls
                    preload="metadata"
                    onerror="this.parentElement.innerHTML='<div style=\\'position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--color-yellow-75); text-align: center;\\'><div style=\\'font-size: 0.75rem;\\'>Video preview unavailable</div></div>'"
                  ></video>
                </div>
                <div style="padding: 1rem;">
                  <div style="color: var(--color-yellow-75); font-family: var(--font-mathias); font-weight: bold; font-size: 0.875rem; margin-bottom: 0.5rem; word-break: break-word;">
                    ${video.name}
                  </div>
                  <div style="color: #888; font-family: var(--font-mathias); font-size: 0.75rem; margin-bottom: 0.25rem;">
                    Size: ${fileSizeMB} MB
                  </div>
                  <div style="color: #888; font-family: var(--font-mathias); font-size: 0.75rem;">
                    Updated: ${updatedDate}
                  </div>
                  <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                    <button 
                      onclick="window.open('${escapedUrl}', '_blank')"
                      style="flex: 1; min-width: 80px; padding: 0.5rem; background: var(--color-yellow-75); color: black; border: none; border-radius: 10px; font-family: var(--font-mathias); font-weight: bold; cursor: pointer; font-size: 0.75rem;"
                    >
                      View
                    </button>
                    <button 
                      onclick="downloadVideo('${escapedUrl}', '${escapedName}')"
                      style="flex: 1; min-width: 80px; padding: 0.5rem; background: transparent; color: var(--color-yellow-75); border: 2px solid var(--color-yellow-75); border-radius: 10px; font-family: var(--font-mathias); font-weight: bold; cursor: pointer; font-size: 0.75rem;"
                    >
                      Download
                    </button>
                    <button 
                      onclick="deleteVideo('${currentFolder}', '${escapedName}')"
                      style="flex: 1; min-width: 80px; padding: 0.5rem; background: transparent; color: #ef4444; border: 2px solid #ef4444; border-radius: 10px; font-family: var(--font-mathias); font-weight: bold; cursor: pointer; font-size: 0.75rem;"
                    >
                      Delete
                    </button>
                  </div>
                </div>
              `;
              
              // Store video data on the card element for deletion
              videoCard.dataset.videoName = video.name;
              videoCard.dataset.videoFullPath = video.fullPath;
              
              videosGrid.appendChild(videoCard);
            });
          }
        } else {
          throw new Error(data.error || 'Failed to load videos');
        }
      } catch (error) {
        console.error('Error loading folder videos:', error);
        videosLoading.innerHTML = `<div style="color: #ef4444;">Error loading videos: ${error.message}</div>`;
      }
    }

    /**
     * Go back to folder list
     */
    window.backToFolders = function() {
      currentFolder = null;
      const folderListView = document.getElementById('folderListView');
      const folderDetailView = document.getElementById('folderDetailView');
      
      folderDetailView.style.display = 'none';
      folderListView.style.display = 'block';
      
      // Reload folders to update counts
      loadFolders();
    }

    /**
     * Handle video load error
     */
    function handleVideoError(videoElement) {
      const container = videoElement.parentElement;
      container.innerHTML = `
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--color-yellow-75); text-align: center; width: 90%;">
          <div style="font-size: 0.75rem; font-family: var(--font-mathias);">Video preview unavailable</div>
          <div style="font-size: 0.65rem; margin-top: 0.5rem; opacity: 0.7;">Click View to open in new tab</div>
        </div>
      `;
    }

    /**
     * Delete a video from Firebase Storage and UI
     */
    window.deleteVideo = async function(folderName, fileName) {
      if (!confirm(`Are you sure you want to delete "${fileName}"?\n\nThis action cannot be undone.`)) {
        return;
      }

      try {
        const response = await fetch(`/api/delete-video?folder=${encodeURIComponent(folderName)}&file=${encodeURIComponent(fileName)}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
          showToast(`Video "${fileName}" deleted successfully`, 'success');
          
          // Remove video card from UI
          const videosGrid = document.getElementById('videosGrid');
          const videoCards = Array.from(videosGrid.querySelectorAll('[data-video-name]'));
          const cardToRemove = videoCards.find(card => card.dataset.videoName === fileName);
          
          if (cardToRemove) {
            cardToRemove.style.opacity = '0';
            cardToRemove.style.transition = 'opacity 0.3s';
            setTimeout(() => {
              cardToRemove.remove();
              
              // Check if grid is empty
              if (videosGrid.children.length === 0) {
                const videosEmpty = document.getElementById('videosEmpty');
                videosEmpty.style.display = 'block';
              }
            }, 300);
          }
          
          // Reload folders to update counts (in background)
          setTimeout(() => {
            loadFolders();
            // Also reload the current folder view if we're in a folder
            if (currentFolder) {
              openFolder(currentFolder);
            }
          }, 500);
        } else {
          throw new Error(data.error || 'Failed to delete video');
        }
      } catch (error) {
        console.error('Error deleting video:', error);
        showToast(`Failed to delete video: ${error.message}`, 'error');
      }
    }

    // Archive functionality
    let archiveAvailableFolders = [];
    let archiveSelectedFolder = null;
    let archiveFolderFiles = [];
    let archiveSelectedFiles = new Set();
    let archiveUploadJobs = new Map();

    // Load archive folders
    window.loadArchiveFolders = async function() {
      const container = document.getElementById('archiveFoldersContainer');
      const loading = document.getElementById('archiveFoldersLoading');
      
      if (!container || !loading) return;
      
      container.innerHTML = '';
      loading.style.display = 'block';

      try {
        const response = await fetch('/api/video-folders');
        const data = await response.json();

        if (data.success && data.folders) {
          archiveAvailableFolders = data.folders;
          loading.style.display = 'none';

          if (archiveAvailableFolders.length === 0) {
            container.innerHTML = '<p style="color: var(--color-yellow-75); text-align: center; grid-column: 1/-1;">No folders available.</p>';
            return;
          }

          archiveAvailableFolders.forEach(folder => {
            const folderCard = document.createElement('div');
            folderCard.className = 'folder-card-item';
            folderCard.onclick = () => archiveSelectFolder(folder.name);

            folderCard.innerHTML = `
              <div class="folder-name" style="font-family: var(--font-mathias); color: var(--color-yellow-75); font-weight: bold; margin-bottom: 0.5rem;">
                ${folder.displayName || folder.name}
              </div>
              <div class="folder-count" style="font-size: 0.75rem; color: #888;">
                ${folder.count} ${folder.type === 'image' ? 'image' : 'video'}(s)
              </div>
            `;

            container.appendChild(folderCard);
          });
        }
      } catch (error) {
        console.error('Error loading archive folders:', error);
        if (loading) loading.innerHTML = '<p style="color: #ef4444;">Error loading folders. Please try again.</p>';
      }
    }

    // Select archive folder and load files
    window.archiveSelectFolder = async function(folderName) {
      archiveSelectedFolder = folderName;
      archiveSelectedFiles.clear();
      
      const fileSection = document.getElementById('archiveFileSelectionSection');
      const uploadSection = document.getElementById('archiveUploadSection');
      const selectedName = document.getElementById('archiveSelectedFolderName');
      const filesLoading = document.getElementById('archiveFilesLoading');
      const filesEmpty = document.getElementById('archiveFilesEmpty');
      const filesContainer = document.getElementById('archiveFilesContainer');

      if (fileSection) fileSection.style.display = 'block';
      if (selectedName) selectedName.textContent = folderName;
      if (uploadSection) uploadSection.style.display = 'block';
      if (filesLoading) filesLoading.style.display = 'block';
      if (filesEmpty) filesEmpty.style.display = 'none';
      if (filesContainer) filesContainer.innerHTML = '';

      try {
        const response = await fetch(`/api/video-folders?folder=${encodeURIComponent(folderName)}`);
        const data = await response.json();

        if (filesLoading) filesLoading.style.display = 'none';

        if (data.success && (data.items || data.videos) && (data.items || data.videos).length > 0) {
          archiveFolderFiles = data.items || data.videos;
          archiveRenderFiles();
        } else {
          if (filesEmpty) filesEmpty.style.display = 'block';
          archiveFolderFiles = [];
        }
      } catch (error) {
        console.error('Error loading archive files:', error);
        if (filesLoading) filesLoading.innerHTML = '<p style="color: #ef4444;">Error loading files.</p>';
      }
    }

    // Render archive files
    function archiveRenderFiles() {
      const container = document.getElementById('archiveFilesContainer');
      if (!container) return;
      container.innerHTML = '';

      archiveFolderFiles.forEach(file => {
        const fileSizeMB = (file.size / (1024 * 1024)).toFixed(2);
        const isSelected = archiveSelectedFiles.has(file.name);

        const fileCard = document.createElement('div');
        fileCard.className = `folder-select-item ${isSelected ? 'selected' : 'unselected'}`;

        fileCard.innerHTML = `
          <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; width: 100%;">
            <input 
              type="checkbox" 
              ${isSelected ? 'checked' : ''}
              onchange="archiveToggleFileSelection('${file.name.replace(/'/g, "\\'")}')"
              style="width: 20px; height: 20px; cursor: pointer; accent-color: #10b981;"
            />
            <div style="flex: 1;">
              <div class="folder-name" style="font-family: var(--font-mathias); color: var(--color-yellow-75); font-weight: bold; margin-bottom: 0.25rem;">
                ${file.name}
              </div>
              <div class="folder-count" style="font-size: 0.75rem; color: #888;">
                ${fileSizeMB} MB ‚Ä¢ ${file.contentType || file.type || 'file'}
              </div>
            </div>
          </label>
        `;

        container.appendChild(fileCard);
      });

      archiveUpdateSelectedCount();
    }

    // Toggle archive file selection
    window.archiveToggleFileSelection = function(fileName) {
      if (archiveSelectedFiles.has(fileName)) {
        archiveSelectedFiles.delete(fileName);
      } else {
        archiveSelectedFiles.add(fileName);
      }
      archiveRenderFiles();
    }

    // Select all archive files
    window.archiveSelectAllFiles = function() {
      archiveFolderFiles.forEach(file => archiveSelectedFiles.add(file.name));
      archiveRenderFiles();
    }

    // Deselect all archive files
    window.archiveDeselectAllFiles = function() {
      archiveSelectedFiles.clear();
      archiveRenderFiles();
    }

    // Update archive selected count
    function archiveUpdateSelectedCount() {
      const countEl = document.getElementById('archiveSelectedCount');
      if (countEl) countEl.textContent = archiveSelectedFiles.size;
    }

    // Archive selected files
    window.archiveSelectedFiles = async function() {
      if (archiveSelectedFiles.size === 0) {
        alert('Please select at least one file to archive.');
        return;
      }

      if (!archiveSelectedFolder) {
        alert('Please select a folder first.');
        return;
      }

      const btn = document.getElementById('archiveBtn');
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'Archiving...';
      }

      const progressSection = document.getElementById('archiveProgressSection');
      const fileProgressList = document.getElementById('archiveFileProgressList');
      if (progressSection) progressSection.style.display = 'block';
      if (fileProgressList) fileProgressList.innerHTML = '';

      const filesToArchive = Array.from(archiveSelectedFiles);
      let completed = 0;
      let failed = 0;

      filesToArchive.forEach(fileName => {
        const jobId = `archive_${Date.now()}_${fileName.replace(/[^a-zA-Z0-9]/g, '_')}`;
        archiveUploadJobs.set(fileName, {
          jobId: jobId,
          fileName: fileName,
          status: 'uploading',
          progress: 0
        });

        const progressItem = document.createElement('div');
        progressItem.id = `archiveProgress_${fileName}`;
        progressItem.style.cssText = `
          background: #1a1a1a;
          border: 1px solid var(--color-yellow-75);
          border-radius: 10px;
          padding: 0.75rem;
          margin-bottom: 0.5rem;
          width: 100%;
        `;
        progressItem.innerHTML = `
          <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
            <span style="color: var(--color-yellow-75); font-size: 0.875rem; font-family: var(--font-mathias);">${fileName}</span>
            <span id="archiveStatus_${fileName}" style="color: var(--color-yellow-75); font-size: 0.75rem;">Uploading...</span>
          </div>
          <div style="width: 100%; height: 8px; background: #0a0a0a; border-radius: 10px; overflow: hidden;">
            <div id="archiveBar_${fileName}" style="height: 100%; background: var(--color-yellow-75); width: 0%; transition: width 0.3s ease;"></div>
          </div>
        `;
        if (fileProgressList) fileProgressList.appendChild(progressItem);
      });

      for (const fileName of filesToArchive) {
        try {
          archiveUpdateFileProgress(fileName, 50, 'Uploading to Arweave...');

          const response = await fetch('/api/archive-upload', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              folder: archiveSelectedFolder,
              fileName: fileName
            })
          });

          const result = await response.json();

          if (result.success) {
            archiveUpdateFileProgress(fileName, 100, 'Complete');
            archiveUpdateFileStatus(fileName, 'completed', result.transactionId, result.arweaveUrl);
            completed++;
            archivePollJobStatus(result.jobId, fileName);
          } else {
            archiveUpdateFileProgress(fileName, 0, 'Failed');
            archiveUpdateFileStatus(fileName, 'failed', null, null, result.error);
            failed++;
          }
        } catch (error) {
          console.error(`Error archiving ${fileName}:`, error);
          archiveUpdateFileProgress(fileName, 0, 'Error');
          archiveUpdateFileStatus(fileName, 'failed', null, null, error.message);
          failed++;
        }

        const overallProgress = Math.round(((completed + failed) / filesToArchive.length) * 100);
        const overallProgressEl = document.getElementById('archiveOverallProgress');
        const overallProgressBar = document.getElementById('archiveOverallProgressBar');
        if (overallProgressEl) overallProgressEl.textContent = `${overallProgress}%`;
        if (overallProgressBar) overallProgressBar.style.width = `${overallProgress}%`;
      }

      if (btn) {
        btn.disabled = false;
        btn.textContent = `Archive ${archiveSelectedFiles.size} File(s) to Arweave`;
      }

      setTimeout(() => {
        loadArchiveManifest();
      }, 2000);
    }

    // Update archive file progress
    function archiveUpdateFileProgress(fileName, percent, status) {
      const bar = document.getElementById(`archiveBar_${fileName}`);
      const statusEl = document.getElementById(`archiveStatus_${fileName}`);
      if (bar) bar.style.width = `${percent}%`;
      if (statusEl) statusEl.textContent = status;
    }

    // Update archive file status
    function archiveUpdateFileStatus(fileName, status, transactionId, arweaveUrl, error = null) {
      const job = archiveUploadJobs.get(fileName);
      if (job) {
        job.status = status;
        job.transactionId = transactionId;
        job.arweaveUrl = arweaveUrl;
        job.error = error;
      }

      const statusEl = document.getElementById(`archiveStatus_${fileName}`);
      if (statusEl) {
        if (status === 'completed') {
          statusEl.innerHTML = `<a href="${arweaveUrl}" target="_blank" style="color: #22c55e; text-decoration: underline;">View on Arweave</a>`;
        } else if (status === 'failed') {
          statusEl.style.color = '#ef4444';
          statusEl.textContent = `Failed: ${error || 'Unknown error'}`;
        } else if (status === 'pending_confirmation') {
          statusEl.style.color = '#f59e0b';
          statusEl.textContent = 'Pending confirmation...';
        }
      }
    }

    // Poll archive job status
    async function archivePollJobStatus(jobId, fileName) {
      const maxAttempts = 30;
      let attempts = 0;

      const poll = async () => {
        if (attempts >= maxAttempts) {
          archiveUpdateFileStatus(fileName, 'pending_confirmation', null, null);
          return;
        }

        try {
          const response = await fetch(`/api/archive-status?jobId=${jobId}`);
          const data = await response.json();

          if (data.success && data.job) {
            if (data.job.status === 'pending_confirmation') {
              archiveUpdateFileStatus(fileName, 'pending_confirmation', data.job.transactionId, data.job.arweaveUrl);
              attempts++;
              setTimeout(poll, 10000);
            } else if (data.job.status === 'completed') {
              archiveUpdateFileStatus(fileName, 'completed', data.job.transactionId, data.job.arweaveUrl);
            } else if (data.job.status === 'failed') {
              archiveUpdateFileStatus(fileName, 'failed', null, null, data.job.error);
            }
          }
        } catch (error) {
          console.error('Error polling archive job status:', error);
          attempts++;
          if (attempts < maxAttempts) {
            setTimeout(poll, 10000);
          }
        }
      };

      setTimeout(poll, 10000);
    }

    // Load archive manifest
    window.loadArchiveManifest = async function() {
      const container = document.getElementById('archiveManifestContainer');
      if (!container) return;
      container.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--color-yellow-75);">Loading manifest...</div>';

      try {
        const response = await fetch('/api/archive-manifest');
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();

        if (data.success && data.manifest) {
          const manifest = data.manifest;
          const folders = manifest.folders || {};

          if (Object.keys(folders).length === 0) {
            container.innerHTML = '<p style="color: var(--color-yellow-75); text-align: center;">No files archived yet.</p>';
            return;
          }

          let html = '';
          Object.entries(folders).forEach(([folderName, folderData]) => {
            const files = folderData.files || [];
            if (files.length === 0) return;

            html += `
              <div style="margin-bottom: 1.5rem; border-bottom: 1px solid rgba(230, 233, 224, 0.2); padding-bottom: 1rem;">
                <h3 style="color: var(--color-yellow-75); font-family: var(--font-mathias); font-size: 1rem; margin-bottom: 0.75rem;">
                  ${folderName} (${files.length} file${files.length !== 1 ? 's' : ''})
                </h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(min(300px, 100%), 1fr)); gap: 0.75rem; width: 100%;">
            `;

            files.forEach(file => {
              html += `
                <div style="background: #1a1a1a; border: 1px solid var(--color-yellow-75); border-radius: 10px; padding: 0.75rem; width: 100%; max-width: 100%; overflow: hidden;">
                  <div style="font-family: var(--font-mathias); color: var(--color-yellow-75); font-size: 0.875rem; margin-bottom: 0.5rem; font-weight: bold; word-wrap: break-word; overflow-wrap: break-word;">
                    ${file.name}
                  </div>
                  <div style="font-size: 0.75rem; color: #888; margin-bottom: 0.5rem;">
                    ${(file.fileSize / (1024 * 1024)).toFixed(2)} MB ‚Ä¢ Archived: ${new Date(file.archivedAt).toLocaleDateString()}
                  </div>
                  <a href="${file.arweaveUrl}" target="_blank" style="color: var(--color-yellow-75); text-decoration: underline; font-size: 0.75rem; word-break: break-all; display: inline-block; max-width: 100%;">
                    View on Arweave ‚Üí
                  </a>
                </div>
              `;
            });

            html += `
                </div>
              </div>
            `;
          });

          container.innerHTML = html;
        }
      } catch (error) {
        console.error('[Archive] Error loading manifest:', error);
        container.innerHTML = `
          <div style="color: #ef4444; text-align: center; padding: 1rem;">
            <p style="margin-bottom: 0.5rem;">Error loading manifest</p>
            <p style="font-size: 0.875rem; color: #888;">${error.message}</p>
            <button onclick="loadArchiveManifest()" class="btn-base btn-secondary" style="margin-top: 1rem; padding: 0.5rem 1rem; border-radius: 10px; background: transparent; color: #ef4444; border: 2px solid #ef4444; cursor: pointer;">
              Retry
            </button>
          </div>
        `;
      }
    }

  </script>

  <!-- Particles.js Library -->
  <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
  <script>
    // Initialize particle system
    particlesJS('particles-js', {
      particles: {
        number: { value: 50, density: { enable: true, value_area: 800 } },
        color: { value: '#E6E9E0' },
        shape: { type: 'circle' },
        opacity: { value: 0.5, random: true },
        size: { value: 2, random: true },
        line_linked: { enable: false },
        move: { enable: true, speed: 1, direction: 'none', random: false, straight: false, out_mode: 'out', bounce: false }
      },
      interactivity: { detect_on: 'canvas', events: { onhover: { enable: false }, onclick: { enable: false }, resize: true } },
      retina_detect: true
    });
  </script>

</body>
</html>

