/**
 * Apply Firebase Updates Script
 * 
 * Updates Firebase artists collection with Arweave image URLs
 * Uses the mapping generated by migrate-images-to-arweave.js
 * 
 * Run: node scripts/apply-firebase-updates.js
 */

import fs from 'fs-extra';
import path from 'path';
import { fileURLToPath } from 'url';
import { initializeApp, cert } from 'firebase-admin/app';
import { getFirestore } from 'firebase-admin/firestore';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const projectRoot = path.join(__dirname, '..');

async function applyUpdates() {
  console.log('='.repeat(60));
  console.log('APPLYING FIREBASE IMAGE UPDATES');
  console.log('='.repeat(60));
  console.log('');
  
  // Load the image mapping
  const mappingPath = path.join(projectRoot, 'image-arweave-mapping.json');
  if (!fs.existsSync(mappingPath)) {
    console.error('❌ Image mapping not found. Run migrate-images-to-arweave.js first.');
    process.exit(1);
  }
  
  const imageMapping = JSON.parse(fs.readFileSync(mappingPath, 'utf8'));
  console.log(`Loaded ${Object.keys(imageMapping).length} image mappings`);
  console.log('');
  
  // Initialize Firebase
  let serviceAccount;
  try {
    // Try environment variable first
    if (process.env.FIREBASE_SERVICE_ACCOUNT_KEY) {
      serviceAccount = JSON.parse(process.env.FIREBASE_SERVICE_ACCOUNT_KEY);
    } else {
      // Try local file
      const keyPath = path.join(projectRoot, 'firebase-key.json');
      if (fs.existsSync(keyPath)) {
        serviceAccount = JSON.parse(fs.readFileSync(keyPath, 'utf8'));
      } else {
        throw new Error('No Firebase credentials found');
      }
    }
  } catch (error) {
    console.error('❌ Could not load Firebase credentials:', error.message);
    console.error('Set FIREBASE_SERVICE_ACCOUNT_KEY env var or create firebase-key.json');
    process.exit(1);
  }
  
  initializeApp({ credential: cert(serviceAccount) });
  const db = getFirestore();
  
  console.log('Connected to Firebase');
  console.log('');
  
  // Get all artists from Firebase
  const artistsRef = db.collection('artists');
  const snapshot = await artistsRef.get();
  
  console.log(`Found ${snapshot.size} artists in Firebase`);
  console.log('');
  
  let updatedCount = 0;
  let skippedCount = 0;
  
  for (const doc of snapshot.docs) {
    const artist = doc.data();
    const updates = {};
    let hasUpdates = false;
    
    // Check artist image
    const artistImg = artist.artistImageFilename;
    if (artistImg && !artistImg.startsWith('http')) {
      const mapping = imageMapping[artistImg];
      if (mapping) {
        updates.artistImageFilename = mapping.arweaveUrl;
        hasUpdates = true;
        console.log(`  ${artist.artistName || doc.id}: artistImage -> Arweave`);
      }
    }
    
    // Check mix images
    if (artist.mixes && Array.isArray(artist.mixes)) {
      const updatedMixes = artist.mixes.map(mix => {
        const mixImg = mix.mixImageFilename;
        if (mixImg && !mixImg.startsWith('http')) {
          const mapping = imageMapping[mixImg];
          if (mapping) {
            console.log(`    - ${mix.mixTitle}: mixImage -> Arweave`);
            return { ...mix, mixImageFilename: mapping.arweaveUrl };
          }
        }
        return mix;
      });
      
      // Check if any mixes were updated
      const mixesChanged = JSON.stringify(updatedMixes) !== JSON.stringify(artist.mixes);
      if (mixesChanged) {
        updates.mixes = updatedMixes;
        hasUpdates = true;
      }
    }
    
    // Apply updates if any
    if (hasUpdates) {
      await doc.ref.update(updates);
      updatedCount++;
    } else {
      skippedCount++;
    }
  }
  
  console.log('');
  console.log('='.repeat(60));
  console.log('UPDATE COMPLETE');
  console.log('='.repeat(60));
  console.log('');
  console.log(`Updated: ${updatedCount} artists`);
  console.log(`Skipped: ${skippedCount} artists (no changes needed)`);
  console.log('');
  
  // Also update the deployment manifest in Firebase to track these
  console.log('Updating deployment manifest with image locations...');
  
  const manifestRef = db.collection('system').doc('image-asset-mapping');
  await manifestRef.set({
    mapping: imageMapping,
    lastUpdated: new Date().toISOString(),
    totalImages: Object.keys(imageMapping).length,
    version: 'v1'
  });
  
  console.log('✅ Saved image mapping to Firebase (system/image-asset-mapping)');
  console.log('');
  console.log('Next step: Redeploy website to Arweave');
  console.log('  The website will now use Arweave URLs for all images');
}

applyUpdates().catch(console.error);
